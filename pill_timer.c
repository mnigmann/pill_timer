/**
 * 
 * PORTB = {buzzer,     ,           ,           backlight,  MISO,       MOSI,       SCK,        SS}
 * PORTF = {,           ,           ,           ,           ,           ,           SPKR        SPKR}
 * PORTK = {R0,         R1,         R2,         R3,         C0,         C1,         C2,         }
 * PORTL = {D7,         D6,         D5,         D4,         phone_pwr,  ,           RS,         E}
 * PORTA = {AUDIO7,     AUDIO6,     AUDIO5,     AUDIO4,     AUDIO3,     AUDIO2,     AUDIO1,     AUDIO0}
 * 
 * TIMER0:
 *  Misc. timing operations                     (2) DTMF samples
 * 
 * TIMER1:
 *  Runs every second to update time            (1) Runs every second to update time
 * 
 * TIMER2:
 *                                              (1) Output PWM (fixed)
 * 
 * TIMER3:
 *  Runs every 10ms to check keypad             (2+1) Misc. timing operations
 * 
 * TIMER4:
 *                                              (1) Runs every 10ms to check keypad
 * Iterates over all 4 columns, even when not all of them are present
 * 
 * TIMER5:
 *                                              (2) Audio playback
 * Press * to stop alarm
 */

#define BUZZER_PERIOD           1.5
#define BUZZER_ON               0.75
#define BUZZER_TOTAL            20

#define BACKLIGHT_ON            120
#define BACKLIGHT_DIM           31
#define BACKLIGHT_BRIGHT        255

#define AUTO_HANGUP             120
#define MAX_SAMPLES_SINCE_RING  3
#define MAX_RINGS               4
#define MAX_TIME_SINCE_RING     7

// #define TEST
// #define DTMF_DEBUG

#define TIME(h,m,s) (3600UL*h+60*m+s)



#include <avr/io.h>
#include <avr/interrupt.h>
#include <string.h>
#include <avr/pgmspace.h>

volatile uint8_t    flags = 0b00000000;             // {,awaitDialTone,enRingCountdown,inCall,enableSets,buzzer,backlight,sendFromTx}

         char       txbuf[32];
volatile uint8_t    txbuflen;
volatile uint8_t    txidx;
volatile char       lcdbuf[16];
volatile uint8_t    lcdbuflen;

uint8_t             waiting = 0;

const char          symlut[16]  =  "123A456B789C*0#D";
volatile uint16_t   mask = 0b0000000000000000;
volatile uint16_t   lastmask = 0;

// Delay counters
volatile uint32_t   set1;
volatile uint32_t   set1_to_afterBreakfast;
volatile uint32_t   afterBreakfast;
volatile uint32_t   beforeDinner;
volatile uint32_t   currentTime = 0;                // COMPTIME is an argument to the compiler
volatile uint8_t    timer_states = 0b00000000;      // {,gab_second_try, set1_to_afterBreakfast, beforeDinner, afterBreakfast_b,afterBreakfast_a, set1_b,set1_a}

volatile uint16_t   backlight_timer;
volatile uint16_t   buzzer_timer;
volatile uint16_t   call_timer;

         uint8_t    time_in_buf[4];
volatile uint8_t    time_in_buflen;



char data[256];
uint32_t chunk_offset=0;

uint32_t    data_len=0;
uint32_t    fmt_len=0;
uint32_t    riff_len=0;
uint32_t    sample_rate=0;
uint16_t    bytes_per_sample=0;
uint32_t    data_offsets[4];
uint32_t    data_lengths[4];
uint8_t     volumes[4];
uint8_t     data_chunks=0;

// Audio playback
volatile uint32_t curr_sample = 0;
volatile uint8_t  curr_chunk = 0;
volatile char recv = 0;
volatile uint8_t finished = 0;

volatile uint8_t adc_sample_num=0;

// DTMF identification
#define NDTMFSAMPLES 200
#define NFREQ 9
float       vx=1.0;
float       vy=0.0;
float       vt=1.0;
uint16_t   freqs[NFREQ] = {697,         770,         852,         941,         1209,        1336,        1477};
const float cosines[NFREQ][NDTMFSAMPLES] PROGMEM = {
/*  440 */  {0.005, 0.004952307128483256, 0.0048101383579304295, 0.004576205863104588, 0.004254972408973459, 0.0038525662138789458, 0.003376664040605122, 0.002836344745633782, 0.0022419160804501613, 0.0016047180490360471, 0.0009369065729286226, 0.0002512215908988469, -0.0004392559827537171, -0.0011213538047469074, -0.0017820593935662541, -0.0024087683705085773, -0.0029895249152875948, -0.0035132498489942473, -0.003969951993239177, -0.004350918773347629, -0.004648882429441257, -0.004858158664573371, -0.004974755084906501, -0.004996447363202946, -0.0049228216726460265, -0.004755282581475767, -0.004497026257831853, -0.004152979495979062, -0.00372970572712091, -0.003235279807847221, -0.002679133974894982, -0.0020718779049664175, -0.0014250963123498806, -0.0007511279456037836, -6.283019941676005e-05, 0.0006266661678215211, 0.0013042075314494861, 0.0019568683341860144, 0.0025721976689075323, 0.0031384568064535033, 0.0036448431371070593, 0.004081696253585922, 0.004440682244067725, 0.004714952679464323, 0.0048992752619212345, 0.004990133642141358, 0.004985794501303069, 0.004886340617840967, 0.004693669288269369, 0.004411456132174766, 0.004045084971874735, 0.0036015451244395314, 0.0030892980654516674, 0.0025181160081788018, 0.0018988954776090017, 0.0012434494358242686, 0.0005642819243674059, -0.00012565047721669137, -0.0008131858259744189, -0.0014852079078851769, -0.0021288964578253665, -0.0027319717336713495, -0.003282928778764787, -0.003771256903680518, -0.0041876402002107085, -0.004524135262330098, -0.004774322723733216, -0.0049334297210393415, -0.004998420946416501, -0.0049680565526000415, -0.004842915805643155, -0.0046253860341722896, -0.0043196170859641754, -0.003931442160683092, -0.0034682665290640207, -0.00293892626146236, -0.0023535196608266635, -0.0017232146158725845, -0.0010600355496102711, -0.0003766340276396601, 0.0003139525976465718, 0.0009985499025720326, 0.0016640977226149406, 0.0022978993031074397, 0.0028878635171113464, 0.003422735529643446, 0.00389231150783512, 0.004287633280968264, 0.004601159236829354, 0.004826908194166369, 0.00496057350657239, 0.0049996052210190805, 0.004943258723689569, 0.004792608945086878, 0.004550529853424976, 0.004221639627510076, 0.0038122125550572334, 0.003330059337171257, 0.002784378082440937, 0.0021855788332546602, 0.0015450849718747313, 0.0008751152948763729, 0.00018845091334966372, -0.0005018085742560759, -0.001182494985118635, -0.0018406227634233938, -0.0024636367077414626, -0.0030396514884730324, -0.003557678386046433, -0.004007834924354383, -0.004381533400219324, -0.0046716447122830615, -0.004872634363932887, -0.004980668045715863, -0.004993684783030087, -0.004911436253643443, -0.00473549152497372, -0.004469207120756313, -0.004117662988142134, -0.0036875655867908597, -0.0031871199487434427, -0.0026258731498064636, -0.002014532178568304, -0.0013647596775866236, -0.0006889514534231775, 5.514005499346031e-18, 0.0006889514534231884, 0.001364759677586634, 0.002014532178568314, 0.002625873149806473, 0.0031871199487434514, 0.003687565586790879, 0.00411766298814214, 0.004469207120756326, 0.004735491524973725, 0.004911436253643444, 0.004993684783030088, 0.004980668045715862, 0.004872634363932882, 0.004671644712283058, 0.004381533400219318, 0.004007834924354377, 0.003557678386046425, 0.0030396514884730307, 0.002463636707741453, 0.0018406227634233752, 0.0011824949851186155, 0.0005018085742560561, -0.00018845091334968364, -0.0008751152948763836, -0.0015450849718747503, -0.00218557883325467, -0.002784378082440939, -0.003330059337171265, -0.0038122125550572403, -0.004221639627510072, -0.00455052985342498, -0.004792608945086884, -0.004943258723689571, -0.0049996052210190805, -0.004960573506572388, -0.004826908194166369, -0.0046011592368293535, -0.004287633280968249, -0.003892311507835107, -0.0034227355296434377, -0.0028878635171113378, -0.0022978993031074453, -0.0016640977226149135, -0.0009985499025720217, -0.0003139525976465608, 0.00037663402763966225, 0.001060035549610282, 0.0017232146158725867, 0.002353519660826673, 0.0029389262614623836, 0.003468266529064035, 0.003931442160683099, 0.004319617085964176, 0.004625386034172288, 0.00484291580564316, 0.004968056552600044, 0.0049984209464165, 0.004933429721039341, 0.004774322723733212, 0.00452413526233009, 0.0041876402002107025, 0.0037712569036805056, 0.003282928778764772, 0.0027319717336713404, 0.0021288964578253648, 0.0014852079078851493, 0.0008131858259743994, 0.0001256504772166759, -0.0005642819243674124, -0.0012434494358242705, -0.0018988954776090119, -0.002518116008178819, -0.0030892980654516795, -0.0036015451244395358},
/*  480 */  {0.005, 0.00494325872368957, 0.004774322723733215, 0.004497026257831855, 0.004117662988142137, 0.003644843137107058, 0.0030892980654516717, 0.0024636367077414587, 0.0017820593935662537, 0.0010600355496102737, 0.00031395259764656764, -0.00043925598275371597, -0.0011824949851186233, -0.0018988954776090062, -0.0025721976689075305, -0.003187119948743449, -0.0037297057271209106, -0.0041876402002107085, -0.0045505298534249785, -0.0048101383579304295, -0.0049605735065723884, -0.0049984209464165, -0.0049228216726460265, -0.004735491524973722, -0.004440682244067723, -0.004045084971874738, -0.0035576783860464256, -0.002989524915287595, -0.002353519660826666, -0.0016640977226149351, -0.0009369065729286231, -0.00018845091334967077, 0.0005642819243674078, 0.0013042075314494816, 0.0020145321785683123, 0.00267913397489498, 0.003282928778764781, 0.0038122125550572395, 0.0042549724089734585, 0.004601159236829352, 0.004842915805643155, 0.004974755084906501, 0.004993684783030087, 0.0048992752619212345, 0.00469366928826937, 0.004381533400219317, 0.0039699519932391795, 0.0034682665290640268, 0.0028878635171113386, 0.0022419160804501644, 0.0015450849718747386, 0.0008131858259744177, 6.283019941676066e-05, -0.0006889514534231859, -0.001425096312349878, -0.0021288964578253665, -0.0027843780824409335, -0.0033766640406051214, -0.0038923115078351145, -0.004319617085964174, -0.004648882429441257, -0.004872634363932885, -0.00498579450130307, -0.00498579450130307, -0.004872634363932886, -0.004648882429441259, -0.00431961708596418, -0.003892311507835117, -0.003376664040605124, -0.0027843780824409366, -0.00212889645782537, -0.0014250963123498817, -0.0006889514534231939, 6.283019941675699e-05, 0.0008131858259744183, 0.001545084971874735, 0.002241916080450157, 0.002887863517111332, 0.003468266529064024, 0.003969951993239174, 0.004381533400219315, 0.004693669288269368, 0.004899275261921234, 0.004993684783030087, 0.004974755084906501, 0.004842915805643156, 0.004601159236829353, 0.004254972408973458, 0.003812212555057239, 0.0032829287787647906, 0.002679133974894979, 0.0020145321785683197, 0.001304207531449494, 0.0005642819243674115, -0.00018845091334966708, -0.0009369065729286152, -0.0016640977226149314, -0.002353519660826659, -0.002989524915287589, -0.003557678386046426, -0.004045084971874735, -0.004440682244067724, -0.004735491524973722, -0.004922821672646025, -0.004998420946416501, -0.00496057350657239, -0.004810138357930432, -0.004550529853424976, -0.004187640200210712, -0.0037297057271209215, -0.0031871199487434427, -0.0025721976689075353, -0.0018988954776090197, -0.0011824949851186321, -0.0004392559827537185, 0.00031395259764655284, 0.0010600355496102657, 0.0017820593935662524, 0.0024636367077414466, 0.0030892980654516665, 0.003644843137107058, 0.00411766298814214, 0.004497026257831853, 0.00477432272373321, 0.004943258723689572, 0.005, 0.0049432587236895725, 0.004774322723733218, 0.004497026257831856, 0.004117662988142145, 0.0036448431371070627, 0.0030892980654516726, 0.0024636367077414687, 0.0017820593935662593, 0.0010600355496102728, 0.0003139525976465779, -0.0004392559827537112, -0.0011824949851186076, -0.0018988954776090132, -0.0025721976689075292, -0.003187119948743437, -0.003729705727120905, -0.004187640200210708, -0.004550529853424972, -0.004810138357930428, -0.0049605735065723884, -0.004998420946416501, -0.004922821672646027, -0.004735491524973721, -0.0044406822440677274, -0.0040450849718747395, -0.0035576783860464378, -0.0029895249152876017, -0.0023535196608266656, -0.001664097722614947, -0.000936906572928631, -0.00018845091334967443, 0.000564281924367413, 0.0013042075314494781, 0.0020145321785683128, 0.002679133974894973, 0.003282928778764765, 0.003812212555057228, 0.004254972408973463, 0.00460115923682935, 0.004842915805643152, 0.004974755084906499, 0.004993684783030089, 0.004899275261921234, 0.004693669288269373, 0.004381533400219319, 0.003969951993239185, 0.00346826652906403, 0.0028878635171113525, 0.0022419160804501557, 0.0015450849718747419, 0.0008131858259744168, 6.283019941677321e-05, -0.0006889514534231691, -0.001425096312349866, -0.0021288964578253713, -0.0027843780824409383, -0.003376664040605112, -0.0038923115078351124, -0.004319617085964167, -0.004648882429441259, -0.0048726343639328845, -0.004985794501303069, -0.004985794501303071, -0.004872634363932891, -0.004648882429441263, -0.004319617085964173, -0.0038923115078351193, -0.003376664040605133, -0.002784378082440947, -0.0021288964578253813, -0.0014250963123498936, -0.0006889514534231975, 6.283019941676219e-05, 0.000813185825974406},
/*  697 */  {0.005, 0.004880609618168331, 0.004528140097982889, 0.003959424027683261, 0.0032016210987841965, 0.0022909210636994637, 0.0012708154523982135, 0.00019002058425720143, -0.0008998489359279495, -0.0019467451328925966, -0.002900672271959247, -0.0037160744629787996, -0.00435401123437837, -0.004784017180269217, -0.00498555687102342, -0.004949005546387631, -0.004676108757003735, -0.004179899003625804, -0.003484073355023594, -0.0026218617671470612, -0.0016344401482747118, -0.0005689639560489472, 0.0005236837657612695, 0.0015913223656701682, 0.0025829655316372212, 0.003451256201172187, 0.004154728152444411, 0.004659786271505782, 0.004942310925683537, 0.0049888098244420176, 0.004797062359270213, 0.004376225651400969, 0.0037463972429308055, 0.0029376553155299936, 0.0019886222722047936, 0.0009446202799206014, -0.0001444931427258541, -0.0012267061287794749, -0.0022503363495889957, -0.003166499163987678, -0.003931442160683096, -0.004508634605093287, -0.004870512006686853, -0.004999792493002788, -0.004890302125391238, -0.004547269742570614, -0.003987077251407159, -0.003236477290068552, -0.002331315624949619, -0.0013148192947775457, -0.00023553225354820968, 0.0008550029019550441, 0.0019047064082856585, 0.002863448464471285, 0.0036854432384455047, 0.00433143542223694, 0.0047705749144523425, 0.0049818901024305294, 0.004955289385779678, 0.004692043112386968, 0.004204722911490842, 0.003516601321035012, 0.002660540380791932, 0.0016774222677723388, 0.0006141969207358169, -0.00047836010825529887, -0.0015480724988553506, -0.0025438549027588324, -0.003418152583396418, -0.00412921244719776, -0.00464307701070509, -0.004935206079339654, -0.004991648692682082, -0.004809709368668968, -0.00439807682944595, -0.0037764090614259057, -0.0029743945254873897, -0.002030334350302475, -0.0009893132177861334, 9.895370785924977e-05, 0.0011824949851186256, 0.0022095648512630802, 0.003131114400897881, 0.003903133972979946, 0.004488754882912317, 0.004860010129076814, 0.004999169989234814, 0.004899588723850347, 0.004566021951042425, 0.0040143995365598175, 0.0032710648446792885, 0.0023715166804778205, 0.001358714003475388, 0.0002810243730029369, -0.0008100859003482099, -0.0018625095877157645, -0.0028259869827463075, -0.0036545061118082862, -0.004308500088832271, -0.004756736677565286, -0.0049778098230154, -0.004961161922283423, -0.004707588015059381, -0.004229197815585697, -0.0035488373992942183, -0.0026989981621386655, -0.0017202651565268166, -0.0006593789053591861, 0.00043299674552147696, 0.0015046941376902516, 0.0025045331268035583, 0.0033847652493892077, 0.0041033540057607894, 0.004625982361517075, 0.00492769159707811, 0.004994073240109605, 0.004821957158728297, 0.004419562954804388, 0.003806107427399194, 0.0030108868523741833, 0.0020718779049664097, 0.0010339240398856198, -5.3406059557924215e-05, -0.0011381856910643528, -0.002168609952870209, -0.0030954697465491805, -0.0038745018142326017, -0.004468502581512554, -0.0048491048570234565, -0.004998132540365633, -0.004908468642731991, -0.00458439516691253, -0.0040413886153151, -0.003305380891752597, -0.0024115208934839404, -0.0014024959351080493, -0.00032649316664815894, 0.0007651016593443185, 0.0018201581736371655, 0.00278829093619215, 0.003623265650935245, 0.004285207137861248, 0.00474250361822043, 0.004973316371452646, 0.004966622668461897, 0.004722742174750552, 0.004253321684424816, 0.003580778914116503, 0.002737231919083735, 0.0017629652584585037, 0.0007045061596878761, -0.00038759744284584235, -0.0014611908827002584, -0.0024650034675888595, -0.0033510969703927306, -0.004077154974456546, -0.004608503742845459, -0.004919768102621972, -0.004996083265480363, -0.004833804712847356, -0.0044406822440677205, -0.003835489875803141, -0.0030471292672251044, -0.0021132494879652843, -0.0010784490433959617, 7.85397840417795e-06, 0.0010937819244120886, 0.002127475053781512, 0.0030595681595476675, 0.0038455480609904252, 0.004447879381891693, 0.0048377970956948796, 0.004996680232506405, 0.0049169411449780515, 0.004602387865152588, 0.00406804224750392, 0.0033394225829605096, 0.0024513249435063477, 0.0014461614556526723, 0.0003719348604467502, -0.0007200539127613054, -0.0017776556813357083, -0.0027503634536861837, -0.003591724448872074, -0.0042615585027039535, -0.00472787691780154, -0.004968410120711322, -0.004971671171057883, -0.004737504333622812, -0.00427709251565957, -0.0036124232142667407, -0.0027752384781183238, -0.001805519029339369, -0.0007495749380335157, 0.00034216596849764635, 0.0014175663447772793, 0.0024252692061870747, 0.00331715054096839, 0.004050617527877937, 0.004590642605464509},
/*  770 */  {0.005, 0.004854419779093655, 0.004426156556662276, 0.003740148994516912, 0.002836344745633782, 0.0017673742188962858, 0.0005954858004743474, -0.0006110789996994476, -0.0017820593935662541, -0.0028492667473596204, -0.003750555348152298, -0.004433441278502784, -0.004858158664573371, -0.004999975326009291, -0.004850632982450529, -0.004418828150443466, -0.00372970572712091, -0.0028233947503303824, -0.0017526716009562916, -0.0005798867240448071, 0.0006266661678215211, 0.0017967269800294578, 0.0028621606279729582, 0.0037609246853205574, 0.004440682244067725, 0.004861849601988383, 0.004999901304280686, 0.004846798312018146, 0.004411456132174766, 0.0037192256490351213, 0.0028104168892606513, 0.0017379516848551788, 0.0005642819243674059, -0.0006422471510015169, -0.0018113768335227354, -0.0028750262602163955, -0.0037712569036805242, -0.004447879381891692, -0.004865492554910633, -0.004999777935544749, -0.004842915805643155, -0.004404040574615016, -0.0037087088636936897, -0.0027974112905108308, -0.001723214615872576, -0.0005486715554552209, 0.0006578217954614136, 0.0018260088094579443, 0.0028878635171113464, 0.003781551901257358, 0.00445503262094184, 0.004869087487385646, 0.0049996052210190805, 0.0048389855016443255, 0.00439658155095278, 0.0036981554748930436, 0.002784378082440937, 0.001708460539457409, 0.0005330557713762869, -0.0006733899474857625, -0.0018406227634233938, -0.002900672271959254, -0.0037918095764436183, -0.00446214189061859, -0.004872634363932887, -0.0049993831624083026, -0.004835007438812174, -0.004389079134805604, -0.0036875655867908597, -0.002771317393683454, -0.0016936896012264507, -0.0005174347262521015, 0.0006889514534232059, 0.0018552185511852576, 0.002913452398342886, 0.0038020298280001625, 0.004469207120756318, 0.004876133149546118, 0.004999111761904045, 0.0048309816564085705, 0.004381533400219318, 0.003676939303905076, 0.0027582293531421436, 0.0016789019469628903, 0.0005018085742560561, -0.0007045061596879186, -0.0018697960286890114, -0.0029262037701275625, -0.0038122125550572516, -0.0044762282416240615, -0.004879583809693739, -0.0049987910221849195, -0.004826908194166369, -0.004373944421667252, -0.003666276731112792, -0.00274511408999066, -0.0016640977226149135, -0.00048617746961198874, 0.0007200539127612557, 0.0018843550520608293, 0.002938926261462369, 0.003822357657115475, 0.004483205183926186, 0.004882986310319123, 0.004998420946416499, 0.004822787092288988, 0.004366312274049594, 0.0036555779736493076, 0.0027319717336713404, 0.0016492770742942546, 0.00047054156659255645, -0.0007355945591932066, -0.0018988954776090119, -0.002951619746781482, -0.00383246503404676, -0.00449013787880308, -0.004886340617840973, -0.004998001538251282, -0.004818618391450049, -0.004358637032692534, -0.0036448431371070514, -0.0027188024138939367, -0.0016344401482746953, -0.0004549010195178448, 0.0007511279456038121, 0.001913417161825462, 0.0029642841008052975, 0.003842534586095398, 0.0044970262578318595, 0.004889646699153613, 0.004997532801828657, 0.004814402132792936, 0.0043509187733476225, 0.0036340723274345035, 0.002705606260634362, 0.001619587090990757, 0.0004392559827536862, -0.0007666539186848022, -0.0019279199613870188, -0.0029769191985417813, -0.0038525662138789545, -0.004503870253026998, -0.0048929045216273654, -0.004997014741774863, -0.004810138357930421, -0.004343157572190956, -0.0036232656509352294, -0.0026923834041332924, -0.0016047180490360335, -0.00042360661071034794, 0.0007821723252011781, 0.001942403733156857, 0.0029895249152875926, 0.003862559818389346, 0.004510669796841017, 0.004896114053108832, 0.004996447363202945, 0.004805827108944254, 0.004335353505822437, 0.0036124232142667276, 0.002679133974894983, 0.0015898331691620506, 0.0004079530578407789, -0.0007976830119924799, -0.0019568683341860287, -0.0030021011266294383, -0.0038725153009936866, -0.004517424822165173, -0.0048992752619212415, -0.004995830671712699, -0.004801468428384713, -0.004327506651265087, -0.0036015451244395206, -0.0026658581036859523, -0.001574932598276496, -0.0003922954786391909, 0.0008131858259744561, 0.001971313621714762, 0.0030146477084451334, 0.0038824325634354033, 0.004524135262330107, 0.004902388116864727, 0.004995164673390623, 0.004797062359270215, 0.004319617085964175, 0.003590631488815913, 0.002652555921533628, 0.0015600164834420564, 0.00037663402763964024, -0.0008286806141406262, -0.0019857394531739006, -0.003027164536905037, -0.003892311507835143, -0.004530801051106454, -0.004905452587216674, -0.004994449374809849, -0.004792608945086882, -0.0043116848877865046, -0.003579682415109132, -0.0026392275597252983},
/*  852 */  {0.005, 0.0048219571587283004, 0.004300508336244443, 0.0034727896245215495, 0.0023977487800431792, 0.001151947133382953, -0.00017589288952618985, -0.001491206324511038, -0.002700320315120579, -0.0037171252252310156, -0.004469207120756319, -0.004903004882677156, -0.004987624676565651, -0.004717040123009111, -0.004110521479095313, -0.003211263265882923, -0.002083308078298839, -0.0008069856549129109, 0.0005268079760194919, 0.0018230838514098535, 0.0029895249152875943, 0.003943060575177198, 0.004615782751822412, 0.004959782098136682, 0.004950559965714646, 0.004588773128419906, 0.003900187008831122, 0.0029338407386250358, 0.001758554732041566, 0.00045802949304829906, -0.0008751152948763773, -0.002145936877385018, -0.0032639309803579194, -0.0041494772651477566, -0.0047395096611059125, -0.004992007750544875, -0.004888989342560899, -0.004437791113178282, -0.0036705461082914463, -0.0026418953201490037, -0.0014250963123498817, -0.00010680602593611418, 0.0012190906798066952, 0.0024581672381892438, 0.0035221801648085134, 0.004335353505822454, 0.004839775384398844, 0.00499952231875316, 0.004803217589654639, 0.004264841457792796, 0.0034227355296434425, 0.0023368721780463644, 0.0010845834815420216, -0.00024494614482234943, -0.001557031408153641, -0.0027582293531421527, -0.003762994101765686, -0.004499769185762423, -0.004916083593399167, -0.00498228860467672, -0.004693669288269373, -0.004070780285432747, -0.0031579819673116156, -0.0020202812163325028, -0.0007387018221839165, 0.0005954858004743526, 0.0018872646295912427, 0.0030446378759545617, 0.003985180731086511, 0.004641910426080912, 0.0049680565526000415, 0.004940391917429819, 0.004560886716669619, 0.0038565682240077337, 0.0028775959856816523, 0.0016936896012264514, 0.0003891634932373925, -0.0009430777243737652, -0.002208155646949917, -0.003315975047384807, -0.004187640200210708, -0.004761073609248974, -0.004995436989129493, -0.004874039651034664, -0.00440552716576338, -0.003623265650935228, -0.0025829655316372256, -0.0013587140034753715, -3.769875465178948e-05, 0.0012860012915280534, 0.0025181160081788195, 0.003570897713330393, 0.00436937030857319, 0.004856668862093374, 0.00499808936628439, 0.004783560257794155, 0.004228359685427088, 0.003372027444135179, 0.0022755490640432707, 0.001017012595625194, -0.00031395259764656873, -0.001622558985914498, -0.0028156113693891364, -0.003808143973614604, -0.004529471468626475, -0.004928222975744992, -0.0049760005544546675, -0.004669401622410475, -0.004030261277609235, -0.0031040972652348468, -0.0019568683341860084, -0.0006702768438519318, 0.0006640498439693372, 0.0019510848034041085, 0.003099169090054807, 0.004026539428555607, 0.004667151158915387, 0.004975381748084035, 0.004929279896116596, 0.004532128844897925, 0.0038122125550572473, 0.0028208014032829313, 0.0016285008529071682, 0.00032022313498538085, -0.0010108599576538636, -0.002269952498697748, -0.0033673855227736253, -0.0042250029923968065, -0.004781727847160865, -0.004997911737086321, -0.004858158664573367, -0.004372421443264675, -0.0035752928871575318, -0.002523542209447154, -0.001292072081721158, 3.1415719827794644e-05, 0.0013526661837692875, 0.002577583635450574, 0.003618932961503468, 0.004402552244821185, 0.004872634363932884, 0.0049957014163914985, 0.004762988919122355, 0.004191069989810755, 0.003320675056917351, 0.00221379115519449, 0.0009492473865704656, -0.0003828990627634888, -0.0016877765372755363, -0.002872455399736288, -0.0038525662138789536, -0.004558308294059052, -0.0049394207102125085, -0.004968761727372964, -0.004644241762316001, -0.003988972197692853, -0.0030496194555372767, -0.0018930815483172042, -0.0006017237940485301, 0.0007324870058013846, 0.0020145321785683097, 0.0031531081381730107, 0.004067128765074821, 0.004691500127515951, 0.004981756284945256, 0.004917226024976651, 0.004502505007943244, 0.0037671284771281423, 0.002763467843311648, 0.001563000942860676, 0.0002512215908988322, -0.0010784490433959808, -0.002331315624949609, -0.003418152583396387, -0.004261558502703972, -0.004801468428384717, -0.004999431521559082, -0.004841349417596776, -0.004338480271275271, -0.00352663698323415, -0.002463636707741427, -0.0012251832805257436, 0.00010052419162729169, 0.0014190726187027817, 0.0026365587573763884, 0.0036662767311128187, 0.0044348929744109375, 0.004887668839349055, 0.004992358925346037, 0.004741507504256327, 0.004152979495979072, 0.003268688180018881, 0.0021516102517380228, 0.0008813008024456667, -0.00045177236639966985, -0.0017526716009562725, -0.0029287505828527183, -0.0038962523346902605, -0.0045862741521358824, -0.004949674657222626},
/*  941 */  {0.005, 0.004783102863200619, 0.004151229199983184, 0.0031591996456960146, 0.001893081548317211, 0.0004627218639153116, -0.0010077830394536705, -0.002390853840513659, -0.0035664969005683644, -0.0044327147741682095, -0.004914355390661896, -0.0049696321617759154, -0.004593749338155808, -0.0038193180830876842, -0.0027135271653204347, -0.0013723137384390467, 8.796005670549932e-05, 0.0015406025380691874, 0.0028595841076516485, 0.003930471435079449, 0.004660355562291055, 0.004985912578331461, 0.004878897529343023, 0.0043485949184137555, 0.0034410131927227715, 0.002234893103355609, 0.0008348762479202331, -0.0006375735146174225, -0.002054708129227219, -0.003293578619761908, -0.004246702001316579, -0.004831386380900953, -0.004996905211369746, -0.004728898268556941, -0.004050617527877912, -0.0030209098495724424, -0.001729111492506449, -0.0002872974026678348, 0.0011794422807902003, 0.0025438549027588255, 0.0036875655867908675, 0.004511347303808963, 0.0049437296955055525, 0.0049471997607760465, 0.00452145644073178, 0.0037034367382243714, 0.0025641111057815723, 0.0012023261304269608, -0.0002637712830031345, -0.0017069842020119013, -0.003002101126629414, -0.004036759195747686, -0.004721192660263453, -0.004996020856663463, -0.004837400005383355, -0.004259091869814863, -0.0033112698014750325, -0.0020761657574911137, -0.0006609359501788969, 0.0008116359032139356, 0.0022137911551944963, 0.00342388042196168, 0.004336917744622083, 0.004873689050745294, 0.00498762467656565, 0.004668839697675198, 0.003944991533744335, 0.002878880422466685, 0.001563000942860705, 0.0001115172915262357, -0.0013496414723024814, -0.002693706887711956, -0.0038040693785928482, -0.004584395166912533, -0.004966984080968126, -0.004918643144747679, -0.004443566362513764, -0.0035829708517969446, -0.002411520893483955, -0.0010308501443195414, 0.00043925598275371054, 0.0018712527638344518, 0.0031409017982337605, 0.004138049789831084, 0.004776185320889367, 0.00499994448357798, 0.00478991418920903, 0.004164316425578408, 0.003177427338173961, 0.0019148682939543126, 0.00048617746961198934, -0.0009846935551843842, -0.0023701336948830404, -0.003549943749680964, -0.004421764750437012, -0.004909958505604979, -0.004972169884105152, -0.004603001497988318, -0.0038344819736327172, -0.0027332871848011957, -0.001394955530196161, 6.440086859371135e-05, 0.001518169921781402, 0.0028402242912853645, 0.003915864054130202, 0.004651767936400447, 0.004984089760086528, 0.004883997664367055, 0.0043601755248331535, 0.0034580695503876498, 0.0022559454222092277, 0.0008580980528896936, -0.000614196920735799, -0.002033204872945888, -0.0032758142989685398, -0.004234217828138096, -0.004825265467904447, -0.004997678601956625, -0.00473649886424564, -0.004064385909691299, -0.0030396514884730476, -0.0017512003853676537, -0.0003108171424430032, 0.0011565322397872678, 0.0025235422094471577, 0.0036716125471784266, 0.004501137985341827, 0.004940149846961407, 0.004950559965714646, 0.004531465171621031, 0.003719225649035134, 0.0025843103686946254, 0.0012251832805257935, -0.00024023930588327975, -0.0016848190052552172, -0.002983225737321141, -0.004022811221046619, -0.004713382210480299, -0.004995025557476261, -0.004843306207809683, -0.004271387158496476, -0.003328887451247462, -0.0020975772812372663, -0.0006842837086207557, 0.0007883775348591107, 0.0021926400463277845, 0.0034066716185643976, 0.0043251442627681, 0.004868372344236313, 0.004989226016769273, 0.004677220154149332, 0.003959424027683259, 0.002898112807225522, 0.0015853646387642547, 0.0001350720499306089, -0.0013269392352596658, -0.002673826792116139, -0.003788736198769619, -0.004574939191982552, -0.004964225700486576, -0.004922821672646029, -0.004454319274497142, -0.00359936523753677, -0.0024321343948495917, -0.001053894357540772, 0.00041578034722389317, 0.001849382425248433, 0.0031225342021195825, 0.004124778487791625, 0.004769161715890143, 0.004999777935544749, 0.00479661914765841, 0.004177311175994398, 0.003195584470893095, 0.0019366125169368515, 0.0005096222789752595, -0.0009615822042498954, -0.0023493609167154358, -0.0035333117667234, -0.004410716534482621, -0.004905452587216673, -0.004974597191601733, -0.0046121514409513354, -0.0038495607134899495, -0.002752986507352027, -0.0014175663447772808, 4.084025035957702e-05, 0.0014957035921487698, 0.0028208014032829174, 0.003901169715276372, 0.00464307701070507, 0.004982156262309397, 0.004888989342560896, 0.004371659306714744, 0.003475049116193078, 0.002276947644255617, 0.000881300802445703, -0.0005908066876480333, -0.0020116564661606215, -0.003257977233579532},
/* 1209 */  {0.005, 0.004643659615665955, 0.0036254298504667555, 0.002090445258750979, 0.0002574966402621606, -0.0016121545589289554, -0.0032520154480662204, -0.004428346563353819, -0.00497347819210148, -0.004809709368668968, -0.003960383071249835, -0.0025465590035430156, -0.0007697582102154629, 0.0011167609577010797, 0.0028441013140670314, 0.004166054408297145, 0.004894194130923601, 0.00492473424650256, 0.0042533216844248154, 0.002975657008857371, 0.0012738536284169078, -0.0006095199486377149, -0.0024060148965896013, -0.0038595657353558154, -0.004762988919122355, -0.004987513982081351, -0.004501137985341827, -0.0033731870927473985, -0.0017644350861288744, 9.58127111791115e-05, 0.0019424037331568285, 0.0035121319980125653, 0.00458125447646681, 0.004997382562570562, 0.004701202959470056, 0.0037349319686055898, 0.0022362981404793415, 0.0004189109768075391, -0.0014581861462552024, -0.0031274390246030888, -0.004350918773347631, -0.00495423529493181, -0.004851394172885071, -0.00405705398518961, -0.002684436926955572, -0.0009291905542127925, 0.0009584990662130702, 0.0027095679163836746, 0.004074425377472935, 0.004858529916582554, 0.004950118288582789, 0.0043361358392019905, 0.003104097265234832, 0.0014296126062660827, -0.0004486435349289413, -0.00226295175225774, -0.0037547075307349563, -0.004711281739386577, -0.004996327969750603, -0.0045692168285146875, -0.0034908270949673666, -0.0019148682939542794, -6.597153141450671e-05, 0.0017923285594689897, 0.0033951570312588776, 0.004514052878491475, 0.004989532990673728, 0.004753824261438357, 0.0038405237064520043, 0.0023798096740252034, 0.0005798867240448115, -0.001302691049182149, -0.002999588250755456, -0.004268935680281519, -0.0049298054374040615, -0.004887999688823951, -0.004149477265147761, -0.002819504312092312, -0.0010876500589558733, 0.0007992336501922787, 0.002572197668907543, 0.003978530525254136, 0.004817778943019233, 0.004970319680707542, 0.004414410168281289, 0.003229287609465661, 0.0015838748154971588, -0.00028729740266785283, -0.00211751935407893, -0.0036459182413030766, -0.00465464196558469, -0.004999910927084747, -0.004632511816027469, -0.0036048122885880955, -0.002063296682601693, -0.0002276867034659109, 0.0016403768626381892, 0.003274627420068222, 0.004442125180131071, 0.004976459502614813, 0.004801468428384717, 0.003942094512099244, 0.00252082960640478, 0.0007402553443955265, -0.0011458320671846552, -0.002868596983083631, -0.00418248311840204, -0.004900214196967631, -0.004919487591426586, -0.004237556146263351, -0.00295161974678145, -0.0012449708213091773, 0.0006391314565431179, 0.0024321343948496225, 0.0038784702511509635, 0.004771983875483016, 0.004985317272524874, 0.004488062720399264, 0.003351096970392729, 0.0017364787474379844, -0.00012565047721667958, -0.0019698699661341505, -0.003533311766723451, -0.004593128898142241, -0.0049982591028171295, -0.004690956679612417, -0.0037150233339647266, -0.00220956485126306, -0.00038916349323736256, 0.0014867077322878936, 0.0031506693559268666, 0.004365546687885596, 0.004958175786008603, 0.004844085578058776, 0.004039538043455976, 0.002659210293278326, 0.0008998489359279367, -0.00098777342769091, -0.002734602366166422, -0.004091651601377721, -0.004865492554910631, -0.004945824913647039, -0.0043211984121522854, -0.003080644909469553, -0.0014009881303719291, 0.00047836010825529974, 0.002289524736952255, 0.003774349315766062, 0.004721192660263459, 0.004995095361931517, 0.004557016383177216, 0.0034693978166637517, 0.0018872646295912563, 3.612800113926012e-05, -0.0018201581736371438, -0.0034170060031565373, -0.0045268069397013146, -0.004991374226366416, -0.00474449022896013, -0.0038213448428911358, -0.0023535196608266405, -0.0005502328385715015, 0.0013314820561515816, 0.0030234126198255174, 0.004284397577519807, 0.004934700983448785, 0.0048816310913714885, 0.004132752279583675, 0.002794806853530094, 0.0010585004081460174, -0.0008286806141406226, -0.0025977446890140497, -0.0039965362275335365, -0.004825676863923288, -0.004966984080968122, -0.004400316491455656, -0.00320644471404046, -0.0015555386399264957, 0.0003170879289066074, 0.0021445180039580693, 0.0036662767311128404, 0.004665458474491679, 0.004999643711512584, 0.004621198963856012, 0.0035840662902536474, 0.002036074592912164, 0.00019786865438229775, -0.0016685407210877336, -0.003297122719825939, -0.004455745527692446, -0.004979263506025931, -0.004793056415784281, -0.003923665499408517, -0.002495010394209786, -0.0007107261038949367, 0.0011748623516271118, 0.002892990446381804, 0.004198762810121184, 0.00490605967246611, 0.004914065659110088},
/* 1336 */  {0.005, 0.004566021951042431, 0.0033394225829605313, 0.0015331287759994094, -0.0005393027249652853, -0.002518116008178804, -0.004059806462481021, -0.004896750161690101, -0.004883661028338007, -0.004022811221046616, -0.0024636367077414583, -0.0004767964937299428, 0.001592811405121065, 0.003385921229591351, 0.004591264858404809, 0.0049996052210190805, 0.004540058015882977, 0.003292396602792046, 0.0014732040480714267, -0.0006017237940485602, -0.0025721976689075314, -0.004096160613412233, -0.004909066041426733, -0.004869800708296346, -0.0039851807310865035, -0.0024087683705085734, -0.00041421497080103785, 0.0016522425108573982, 0.003431885200009175, 0.004615782751822416, 0.0049984209464165, 0.004513377152932792, 0.0032448507150333082, 0.0014130466841463412, -0.0006640498439693579, -0.002625873149806481, -0.004131867933098384, -0.004920606722727726, -0.004855171390270322, -0.003946920934891264, -0.0023535196608266643, -0.00035156803852650227, 0.0017114127083478726, 0.003477307235970235, 0.004639571759635654, 0.004996447363202945, 0.004485983575409436, 0.0031967924277311703, 0.001352666183769264, -0.0007262710327218696, -0.0026791339748949887, -0.004166922782939762, -0.004931370383185718, -0.004839775384398843, -0.003908037874126256, -0.0022978993031074297, -0.0002888655895831951, 0.0017703126539323566, 0.0035221801648085242, 0.004662628125284425, 0.004993684783030087, 0.004457881609076343, 0.0031482293298462872, 0.0012920720817211737, -0.0007883775348591312, -0.0027319717336713616, -0.004201319627369212, -0.0049413553230939445, -0.004823615121889708, -0.0038685376888775006, -0.002241916080450156, -0.0002261175254146566, 0.0018289330466266858, 0.0035664969005683696, 0.004684948207901318, 0.004990133642141357, 0.004429075691559783, 0.0030991690900548023, 0.0012312739465131708, -0.0008503595430444589, -0.002784378082440937, -0.004235053034726249, -0.004950559965714651, -0.004806693154635711, -0.0038284266166821596, -0.002185578833254648, -0.0001633337546676176, 0.001887264629591272, 0.0036102504451234717, 0.004706528482886541, 0.004985794501303067, 0.004399570371648041, 0.0030496194555372906, 0.0011702813788756672, -0.0009122072696002591, -0.0028363447456337754, -0.004268117678114839, -0.0049589828575280544, -0.004789012154811644, -0.003787710991543527, -0.0021288964578253513, -0.00010052419162725617, 0.00194529819159298, 0.003653433889281938, 0.004727365542464503, 0.004980668045715859, 0.004369370308573188, 0.0029995882507554104, 0.0011091040102421072, -0.0009739109480535473, -0.0028878635171113555, -0.004300508336244445, -0.004966622668461902, -0.00477057491445233, -0.0037463972429307903, -0.0020718779049664136, -3.769875465175885e-05, 0.0020030245684596235, 0.003696040413877338, 0.0047474560962219485, 0.004974755084906498, 0.004338480271275245, 0.0029490833762164342, 0.0010477515012281883, -0.0010354608346782388, -0.002938926261462379, -0.004332219894254685, -0.004973478192101481, -0.004751384345011775, -0.0037044918947637807, -0.002014532178568278, 2.5132635394115783e-05, 0.0020604346445271095, 0.00373806329084555, 0.004766796971627543, 0.004968056552600043, 0.004306905137649228, 0.0028981128072254948, 0.00098623354010627, -0.0010968472100336569, -0.0029895249152876034, -0.004363247344522953, -0.004979548345880141, -0.004731443476903349, -0.0036620015643827313, -0.0019568683341859815, 8.796005670551494e-05, 0.002117519354078941, 0.0037794958842871096, 0.004785385114532856, 0.004960573506572387, 0.004274649893774746, 0.0028466845926263047, 0.0009245598412756568, -0.0011580603804995546, -0.00303965148847306, -0.0043935857874551525, -0.004984832171250236, -0.004710755459021288, -0.003618932961503421, -0.0018988954776090125, 0.00015077358810429496, 0.0021742696827776044, 0.003820331651515257, 0.0048032175896546596, 0.004952307128483254, 0.0042417196331287245, 0.002794806853530154, 0.0008627401437281637, -0.0012190906798067098, -0.0030892980654517004, -0.004423230432259433, -0.004989328833834471, -0.004689323558243436, -0.0035752928871574875, -0.0018406227634233355, 0.00021356331060569045, 0.002230676669088551, 0.003860564144088918, 0.004820291581038352, 0.004943258723689558, 0.004208119555781058, 0.002742487782033313, 0.0008007842095109148, -0.0012799284705633756, -0.0031384568064535823, -0.004452176597702747, -0.00499303762355772, -0.004667151158915376, -0.0035310882326185624, -0.0017820593935662702, 0.00027631930898470785, 0.00228673140569456, 0.0039001870088311475, 0.004836604392502843, 0.00493342972103934, 0.004173854967573465, 0.0026897356399238214, 0.0007387018221838589, -0.0013405641457771384},
/* 1477 */  {0.005, 0.0044713180916513655, 0.002997074190691523, 0.0008890307286927862, -0.0014070185181963004, -0.0034055216709726337, -0.00468384974537599, -0.004971671171057886, -0.0042081195557810746, -0.002554665269580441, -0.00036096885941430364, 0.0019090626329316674, 0.0037753793749034886, 0.004843306207809686, 0.004887005693251239, 0.0038972365802853095, 0.002083308078298844, -0.00017118333989289, -0.002389474144159797, -0.004102456248233046, -0.004947880593013255, -0.004746962956115291, -0.003542191945417604, -0.0015883438157437018, 0.0007013957697786619, 0.002842809253671313, 0.004383046009043134, 0.004996387913038633, 0.00455312985834801, 0.0031470088506691516, 0.001075381185085573, -0.0012236603113513166, -0.003263930980357912, -0.004613969145598976, -0.004988278505657246, -0.004307702825817379, -0.002716165325756722, -0.000550232838571493, 0.0017320589074665447, 0.003648067370075947, 0.004792608945086879, 0.004923644262874905, 0.004013462922692327, 0.0022545434876875626, 1.8849511272540203e-05, -0.0022208306233788846, -0.003990865569195495, -0.004916941144978052, -0.00480321758965464, -0.0036737443377262984, -0.001767374218896301, 0.0005127474098586231, 0.00268443692695558, 0.004288441149098761, 0.00498555687102342, 0.004628363104646749, 0.003292396602792069, 0.001260177893335497, -0.0010385341175240103, -0.0031176244487284136, -0.004537422122705579, -0.004997678601956626, -0.00440106217696944, -0.002873740971789789, -0.0007387018221839364, 0.0015525526430430598, 0.0035154845106157378, 0.004734987154251476, 0.004953168980000836, 0.00412389047426215, 0.002422521454222013, 0.0002088551280084077, -0.002048978369262752, -0.0038735087487631204, -0.0048788975293430235, -0.004852532367342716, -0.0037999887764263197, -0.0019438510583001194, 0.00032335821464513445, 0.002522186032390838, 0.004187640200210706, 0.004967522523020616, 0.004696909130936384, 0.0034330273857787353, 0.0014431538527304134, -0.0008519074134787927, -0.0029668134648502403, -0.004454319274497134, -0.004999857878369914, -0.004488062720399286, -0.003027164536905022, -0.0009261035037082453, 0.001370803196556033, 0.003377822356850081, 0.004670524089271233, 0.004975537186290727, 0.004228359685427089, 0.0025869992774930624, 0.0003985589835904154, -0.0018741656799258922, -0.0037505553481522757, -0.004833804712847361, -0.004894836037473309, -0.0039207428591612505, -0.002117519354078912, 0.0001335018202352398, 0.0023562909957133994, 0.004080788803096222, 0.004942310925683535, 0.0047586688995337936, 0.003568698011382115, 0.0016240446932394687, -0.0006640498439692978, -0.002811715925678805, -0.004364780670859403, -0.004994813186202744, -0.0045685787546954505, -0.0031762143493988025, -0.001112167118676341, 0.001187073165927888, 0.003235279807847202, 0.004599312888624756, 0.0049907165633820555, 0.004326719615436986, 0.002747739314220393, 0.0005876869872892027, -0.0016966451308226718, -0.003622183014713077, -0.004781727847160852, -0.0049300674782323155, -0.004035832116232004, -0.0022881281842380133, -5.654746224833103e-05, 0.0021869915078428707, 0.003968041340370594, 0.004909958505604978, 0.004813553177777007, 0.0036992124579631317, 0.00180258905748404, -0.0004752328321466334, -0.0026525559215336255, -0.004268935680281516, -0.004982551814201836, -0.004642493947490904, -0.0033206750569173423, -0.0012966238359051097, 0.0010016280106977743, 0.0030880628140402032, 0.004521456440731781, 0.0049986851795827975, 0.004418828150443482, 0.0029045093216077305, 0.0007759658803863996, -0.0015166732098174404, -0.003488577225258202, -0.004722742174750539, -0.004958175786008604, -0.004145090262676655, -0.002455431047205025, -0.0002465150429913967, 0.002014532178568304, 0.003849560713489922, 0.00487051200668684, 0.004861482666951703, 0.0038243821537094318, 0.001978528978356148, -0.00028572918739728966, -0.002489563412325087, -0.004166922782939746, -0.004963091478023962, -0.00470970150354395, -0.0034603379376055244, -0.0014792071459133244, 0.0008147356684766281, 0.002936384079662671, 0.00443706723529641, 0.004999431521559081, 0.0045045522088313, 0.003057082792895139, 0.0009631236309879574, -0.0013345099466018412, -0.0033499310180797486, -0.004656932920167725, -0.004979120348941376, -0.0042483594385247046, -0.002619186217983918, -0.0004361264502255053, 0.0018391621831275204, 0.003725518107385153, 0.004824028422602888, 0.004902388116864739, 0.0039440262490906325, 0.0021516102517380297, -9.581271117910508e-05, -0.00232297389530015, -0.004058889370616664, -0.00493646029463975, -0.004770104319039868, -0.0035950012016751675, -0.0016596532459835734},
};
const float sines[NFREQ][NDTMFSAMPLES] PROGMEM = {
/*  440 */  {0.0, 0.0006889514534231904, 0.001364759677586626, 0.0020145321785683136, 0.0026258731498064788, 0.003187119948743449, 0.0036875655867908697, 0.004117662988142137, 0.004469207120756319, 0.004735491524973722, 0.004911436253643444, 0.004993684783030087, 0.004980668045715862, 0.004872634363932885, 0.00467164471228306, 0.004381533400219318, 0.004007834924354383, 0.0035576783860464256, 0.0030396514884730263, 0.0024636367077414583, 0.0018406227634233888, 0.0011824949851186209, 0.0005018085742560727, -0.00018845091334967367, -0.0008751152948763825, -0.0015450849718747386, -0.002185578833254667, -0.0027843780824409418, -0.003330059337171259, -0.0038122125550572395, -0.004221639627510076, -0.00455052985342498, -0.00479260894508688, -0.00494325872368957, -0.0049996052210190805, -0.004960573506572389, -0.004826908194166369, -0.004601159236829351, -0.004287633280968262, -0.0038923115078351167, -0.0034227355296434416, -0.0028878635171113347, -0.0022978993031074345, -0.0016640977226149312, -0.0009985499025720315, -0.0003139525976465619, 0.00037663402763966555, 0.0010600355496102765, 0.0017232146158725897, 0.0023535196608266643, 0.002938926261462368, 0.003468266529064028, 0.003931442160683098, 0.004319617085964178, 0.004625386034172292, 0.004842915805643157, 0.004968056552600042, 0.0049984209464165, 0.00493342972103934, 0.004774322723733214, 0.004524135262330096, 0.004187640200210705, 0.0037712569036805147, 0.003282928778764783, 0.002731971733671345, 0.0021288964578253617, 0.0014852079078851714, 0.0008131858259744134, 0.00012565047721668142, -0.0005642819243674158, -0.0012434494358242738, -0.0018988954776090067, -0.002518116008178807, -0.0030892980654516748, -0.003601545124439538, -0.004045084971874741, -0.004411456132174766, -0.004693669288269371, -0.004886340617840968, -0.004985794501303069, -0.004990133642141357, -0.0048992752619212345, -0.0047149526794643196, -0.004440682244067722, -0.004081696253585914, -0.0036448431371070554, -0.003138456806453499, -0.002572197668907527, -0.0019568683341860053, -0.001304207531449485, -0.0006266661678215113, 6.283019941676556e-05, 0.0007511279456037892, 0.0014250963123498858, 0.0020718779049664266, 0.0026791339748949822, 0.003235279807847229, 0.0037297057271209124, 0.004152979495979065, 0.004497026257831857, 0.00475528258147577, 0.004922821672646028, 0.004996447363202946, 0.004974755084906501, 0.004858158664573367, 0.004648882429441256, 0.004350918773347626, 0.0039699519932391725, 0.00351324984899424, 0.0029895249152875935, 0.0024087683705085665, 0.0017820593935662502, 0.001121353804746901, 0.00043925598275370935, -0.0002512215908988557, -0.0009369065729286235, -0.001604718049036049, -0.002241916080450172, -0.0028363447456337867, -0.003376664040605133, -0.0038525662138789506, -0.004254972408973469, -0.004576205863104592, -0.00481013835793043, -0.004952307128483258, -0.005, -0.0049523071284832566, -0.004810138357930428, -0.004576205863104588, -0.004254972408973463, -0.003852566213878944, -0.003376664040605112, -0.002836344745633777, -0.0022419160804501466, -0.0016047180490360389, -0.0009369065729286215, -0.00025122159089883587, 0.00043925598275372036, 0.0011213538047469202, 0.0017820593935662604, 0.002408768370508576, 0.0029895249152876026, 0.0035132498489942477, 0.003969951993239173, 0.004350918773347631, 0.004648882429441263, 0.004858158664573372, 0.004974755084906503, 0.004996447363202946, 0.0049228216726460265, 0.004755282581475764, 0.0044970262578318525, 0.004152979495979064, 0.0037297057271209045, 0.0032352798078472207, 0.0026791339748949883, 0.0020718779049664167, 0.0014250963123498667, 0.0007511279456037782, 6.283019941674566e-05, -0.000626666167821531, -0.001304207531449487, -0.0019568683341860075, -0.002572197668907552, -0.0031384568064535146, -0.003644843137107063, -0.004081696253585921, -0.00444068224406772, -0.004714952679464329, -0.004899275261921237, -0.004990133642141358, -0.004985794501303069, -0.004886340617840965, -0.0046936692882693695, -0.004411456132174761, -0.004045084971874725, -0.0036015451244395245, -0.003089298065451666, -0.0025181160081788044, -0.0018988954776090132, -0.0012434494358242545, -0.000564281924367396, 0.00012565047721669245, 0.0008131858259744155, 0.001485207907885182, 0.0021288964578253795, 0.0027319717336713543, 0.0032829287787647984, 0.0037712569036805277, 0.004187640200210712, 0.004524135262330097, 0.004774322723733223, 0.004933429721039343, 0.004998420946416501, 0.0049680565526000415, 0.004842915805643156, 0.004625386034172288, 0.004319617085964168, 0.003931442160683089, 0.0034682665290640237},
/*  480 */  {0.0, 0.0007511279456037854, 0.0014852079078851747, 0.0021855788332546646, 0.0028363447456337828, 0.003422735529643443, 0.003931442160683095, 0.004350918773347628, 0.00467164471228306, 0.004886340617840967, 0.004990133642141358, 0.004980668045715862, 0.00485815866457337, 0.00462538603417229, 0.0042876332809682624, 0.003852566213878946, 0.003330059337171258, 0.002731971733671346, 0.0020718779049664214, 0.0013647596775866271, 0.0006266661678215226, -0.00012565047721668784, -0.0008751152948763805, -0.0016047180490360452, -0.002297899303107439, -0.0029389262614623653, -0.0035132498489942473, -0.004007834924354382, -0.004411456132174764, -0.004714952679464321, -0.004911436253643444, -0.004996447363202946, -0.004968056552600042, -0.00482690819416637, -0.0045762058631045885, -0.004221639627510078, -0.0037712569036805203, -0.0032352798078472216, -0.002625873149806481, -0.0019568683341860123, -0.0012434494358242768, -0.0005018085742560755, 0.00025122159089884866, 0.0009985499025720334, 0.0017232146158725856, 0.002408768370508578, 0.003039651488473023, 0.0036015451244395323, 0.004081696253585919, 0.0044692071207563175, 0.004755282581475767, 0.00493342972103934, 0.0049996052210190805, 0.0049523071284832566, 0.004792608945086881, 0.004524135262330096, 0.004152979495979067, 0.00368756558679087, 0.003138456806453505, 0.0025181160081788096, 0.00184062276342339, 0.0011213538047469083, 0.0003766340276396598, -0.0003766340276396561, -0.0011213538047469048, -0.0018406227634233862, -0.002518116008178799, -0.0031384568064535025, -0.003687565586790868, -0.004152979495979065, -0.004524135262330095, -0.004792608945086879, -0.004952307128483256, -0.0049996052210190805, -0.00493342972103934, -0.004755282581475769, -0.004469207120756321, -0.004081696253585924, -0.0036015451244395353, -0.00303965148847303, -0.0024087683705085816, -0.001723214615872593, -0.0009985499025720371, -0.00025122159089885235, 0.0005018085742560762, 0.0012434494358242734, 0.0019568683341860092, 0.0026258731498064814, 0.003235279807847222, 0.003771256903680512, 0.004221639627510078, 0.004576205863104585, 0.004826908194166367, 0.004968056552600042, 0.004996447363202946, 0.004911436253643445, 0.004714952679464323, 0.004411456132174769, 0.004007834924354387, 0.0035132498489942464, 0.002938926261462368, 0.0022978993031074362, 0.0016047180490360467, 0.0008751152948763905, 0.00012565047721668264, -0.0006266661678215146, -0.0013647596775866176, -0.002071877904966426, -0.0027319717336713413, -0.0033300593371712456, -0.0038525662138789506, -0.004287633280968259, -0.004625386034172284, -0.004858158664573367, -0.004980668045715862, -0.004990133642141359, -0.004886340617840969, -0.004671644712283061, -0.004350918773347635, -0.003931442160683098, -0.003422735529643443, -0.002836344745633777, -0.002185578833254669, -0.00148520790788519, -0.0007511279456037777, -3.673940397442059e-18, 0.0007511279456037703, 0.0014852079078851662, 0.0021855788332546624, 0.002836344745633771, 0.003422735529643438, 0.003931442160683094, 0.0043509187733476225, 0.004671644712283058, 0.004886340617840967, 0.004990133642141357, 0.004980668045715862, 0.004858158664573373, 0.004625386034172288, 0.004287633280968263, 0.0038525662138789558, 0.0033300593371712647, 0.0027319717336713473, 0.002071877904966433, 0.001364759677586633, 0.000626666167821522, -0.0001256504772166753, -0.0008751152948763746, -0.001604718049036048, -0.0022978993031074297, -0.0029389262614623623, -0.0035132498489942347, -0.004007834924354377, -0.004411456132174764, -0.004714952679464318, -0.004911436253643442, -0.004996447363202946, -0.0049680565526000415, -0.004826908194166371, -0.0045762058631045885, -0.004221639627510081, -0.0037712569036805342, -0.0032352798078472346, -0.0026258731498064723, -0.0019568683341860157, -0.001243449435824289, -0.0005018085742560835, 0.0002512215908988273, 0.0009985499025720386, 0.001723214615872578, 0.002408768370508575, 0.003039651488473017, 0.00360154512443953, 0.004081696253585909, 0.004469207120756322, 0.004755282581475766, 0.004933429721039341, 0.0049996052210190805, 0.004952307128483259, 0.004792608945086884, 0.004524135262330094, 0.0041529794959790645, 0.003687565586790879, 0.0031384568064535085, 0.002518116008178821, 0.001840622763423385, 0.001121353804746912, 0.0003766340276396634, -0.00037663402763965243, -0.001121353804746884, -0.0018406227634233745, -0.0025181160081788113, -0.0031384568064534994, -0.0036875655867908597, -0.004152979495979058, -0.004524135262330089, -0.004792608945086875, -0.004952307128483255, -0.0049996052210190805, -0.004933429721039342},
/*  697 */  {0.0, 0.001086116823846669, 0.0021203648867681966, 0.0030533524803082373, 0.0038405237064520086, 0.004444286295897027, 0.004835806870207487, 0.004996387913038633, 0.004918360691583054, 0.004605451485745885, 0.004072603635352547, 0.0033452639037296933, 0.0024581672381892464, 0.0014536779625793925, 0.00037976662016448815, -0.0007122809149657645, -0.0017703126539323458, -0.0027438010714131624, -0.003586256105859513, -0.004257445345975975, -0.0047253153758990245, -0.004967522523020618, -0.004972499905829873, -0.0047400098236731435, -0.004281155108422731, -0.0036178488959422456, -0.0027817681390234256, -0.0018128408379905383, -0.0007573392330185621, 0.00033432998003589816, 0.0014100328795006501, 0.00241839803341389, 0.0033112698014750256, 0.004046008063157855, 0.004587524545818915, 0.004909958505604984, 0.004997911737086321, 0.004847183932306972, 0.00446497327133304, 0.0038695326648660474, 0.003089298065451671, 0.0021615304757868436, 0.0011305365065840233, 4.555246330292871e-05, -0.0010416069903730184, -0.0020790233015292973, -0.0030171534583629533, -0.0038111959738211477, -0.00442323043225941, -0.004824028422602906, -0.0049944493748098505, -0.004926354639857798, -0.00462299616030941, -0.004098861170046753, -0.0033789803397173395, -0.00249773240820371, -0.0014972023863185717, -0.00042517173860068155, 0.000667163475603437, 0.0017276375289689719, 0.0027056062606343845, 0.003554365646482479, 0.004233382203649408, 0.004710228713723093, 0.004962132821938429, 0.00497706455722949, 0.004754310837365154, 0.0043045095230130285, 0.0036491413944406696, 0.0028195043120923025, 0.001855218551185247, 0.0008023346897953032, -0.0002888655895832141, -0.0013662707597463834, -0.002378428094832943, -0.0032770008545589834, -0.004019076660969612, -0.004569216828514688, -0.004901148779328541, -0.004999020720471251, -0.004858158664573369, -0.004485289641490587, -0.003898220441238528, -0.0031249872302090737, -0.0022025166517261182, -0.0011748623516271033, -9.110114562390719e-05, 0.0009970107006038254, 0.002037509151537417, 0.0029807040042359656, 0.0037815519012573745, 0.004401807428115803, 0.0048118495671373475, 0.004992096283304069, 0.004933939686909136, 0.0046401571132524, 0.004124778487791607, 0.0034124163108794157, 0.0025370902594374356, 0.0015406025380691668, 0.00047054156659256436, -0.0006219906598053183, -0.0016848190052552454, -0.002667186876963287, -0.003522180164808531, -0.004208967678751181, -0.00469475108938054, -0.004956331249943583, -0.0049812160983406266, -0.004768217229950896, -0.00432750665126509, -0.003680131003989833, -0.0028570064584118255, -0.0018974422760476564, -0.0008472635505471662, 0.0002433772224780931, 0.001322395235695036, 0.002338260740063159, 0.003242459907400042, 0.003991811664169576, 0.004550529853424984, 0.004891932243985663, 0.004999714771144699, 0.004868730156073179, 0.004505233720054074, 0.0039265846544037164, 0.0031604170122799106, 0.0022433200126187173, 0.0012190906798066853, 0.00013664226629481728, -0.000952331656155964, -0.0019958258825832063, -0.0029440071433339795, -0.0037515939493016574, -0.004380019061635511, -0.004799271314689908, -0.004989328833834472, -0.0049411152031569325, -0.004656932920167717, -0.004150353437377196, -0.0034455690419367296, -0.002576237525078581, -0.00158387481549715, -0.0005158723383174283, 0.0005767662170415558, 0.0016418606368484604, 0.0026285461093162594, 0.003489702332322721, 0.004184203797755216, 0.0046788837875574914, 0.004950118288582793, 0.004984954184573752, 0.004781727847160861, 0.004350144584352904, 0.003710815152365402, 0.00289427146519884, 0.0019395085078904395, 0.0008921220860529148, -0.00019786865438233938, -0.0012784099491378687, -0.002297899303107443, -0.003207649826993528, -0.003964215335828794, -0.004531465171621036, -0.004882309664574579, -0.004999993831498518, -0.0048788975293430166, -0.004524803851609189, -0.003954622950052521, -0.0031955844708930446, -0.002283937171671491, -0.001263217820047749, -0.0001821720452751789, 0.0009075735655151751, 0.0019539769544946544, 0.002907065921599174, 0.00372132460454787, 0.004357867141313925, 0.0047862947092907416, 0.004986147256107109, 0.004947880593013249, 0.004673322188616453, 0.00417558389601112, 0.003478435781119812, 0.0026151709557945997, 0.001627015626882364, 0.0005611602911943272, -0.0005314939010674942, -0.0015987659894134212, -0.0025896871649851616, -0.003456934844776041, -0.004159092616132934, -0.004662628125284432, -0.004943494453549235, -0.004988278505657244, -0.004794841567576012, -0.004372421443264672, -0.003741191292697169, -0.002931296239353511, -0.0019814137550986234},
/*  770 */  {0.0, 0.0011977514802096092, 0.002325755390387292, 0.0033183257071622927, 0.004117662988142137, 0.004677220154149337, 0.004964413022849068, 0.004962517753734119, 0.00467164471228306, 0.00410873204314795, 0.003306559326618259, 0.002311838755204957, 0.0011824949851186209, -1.5707937429400666e-05, -0.001212996153977038, -0.0023396490713028678, -0.003330059337171259, -0.004126553293465, -0.004682749433740963, -0.004966259295211697, -0.004960573506572389, -0.004666023163169492, -0.004099760546627259, -0.003294760311668584, -0.0022978993031074345, -0.0011672268192795259, 3.141571982780046e-05, 0.001228228855962133, 0.0023535196608266643, 0.00334176010083897, 0.0041354028713728105, 0.004688232496486181, 0.004968056552600042, 0.004958580300552814, 0.004660355562291052, 0.004090748587125115, 0.0032829287787647767, 0.0022839371716714945, 0.0011519471333829535, -4.712319216572415e-05, -0.0012434494358242738, -0.002367367022061565, -0.003353427882683607, -0.004144211634523812, -0.004693669288269374, -0.0049698047772758994, -0.004956538155347533, -0.004654641965584677, -0.004081696253585914, -0.003271064844679307, -0.002269952498697732, -0.0011366560782332257, 6.283019941677444e-05, 0.0012586577433424924, 0.002381191018339698, 0.0033650625675488723, 0.004152979495979065, 0.004699059755431601, 0.0049715039519849956, 0.0049544470911116936, 0.004648882429441256, 0.004072603635352542, 0.0032591686265043833, 0.0022559454222092247, 0.001121353804746901, -7.853658655911319e-05, -0.0012738536284169163, -0.002394991513223814, -0.003376664040605133, -0.004161706369203328, -0.004704403844771129, -0.004973154059957163, -0.004952307128483254, -0.004643077010705086, -0.0040634708221654655, -0.0032472402416509095, -0.002241916080450162, -0.0011060404639512322, 9.42421985770491e-05, 0.0012890369410703117, 0.002408768370508576, 0.0033882321873505146, 0.004170392168065861, 0.0047097015035439576, 0.004974755084906503, 0.004950118288582787, 0.004637225766673303, 0.004054297904161858, 0.003235279807847207, 0.002227864611884476, 0.001090716206982702, -0.00010994688046254106, -0.001304207531449487, -0.0024225214542220115, -0.0033997668936121047, -0.004179036806841351, -0.004714952679464329, -0.004976307011031542, -0.004947880593013256, -0.004631328755095327, -0.004045084971874734, -0.0032232874431379365, -0.0022137911551944954, -0.0010753811850855665, 0.0001256504772167102, 0.0013193652498268737, 0.002436250628626674, 0.003411268045546996, 0.004187640200210712, 0.004720157320705252, 0.004977809823015402, 0.0049455940638598065, 0.004625386034172288, 0.004035832116231994, 0.0032112632658829092, 0.002199695849279573, 0.0010600355496102483, -0.0001413528338513786, -0.001334509946601877, -0.0024499557582212017, -0.00342273552964345, -0.004196202263261926, -0.0047253153758990305, -0.004979263506025929, -0.004943258723689566, -0.004619397662556428, -0.004026539428555609, -0.003199207394755874, -0.002185578833254655, -0.0010446794520120439, 0.0001570537953906611, 0.001349641472302488, 0.0024636367077414674, 0.003434169232722053, 0.004204722911490856, 0.004730426794137723, 0.004980668045715865, 0.004940874595551403, 0.004613363699350559, 0.004017207000560633, 0.003187119948743439, 0.002171440246449007, 0.0010293130438493849, -0.00017275320687238824, -0.0013647596775866566, -0.0024772933421620385, -0.0034455690419367465, -0.004213202060802166, -0.0047354915249737265, -0.0049820234282229635, -0.004938441702975685, -0.0046072842041074815, -0.004007834924354384, -0.003175001047143774, -0.0021572802284047883, -0.0010139364767825507, 0.00018845091334968912, 0.001379864413243749, 0.0024909255266974766, 0.003456934844776054, 0.004221639627510075, 0.004740509518420161, 0.00498332964017015, 0.004935960069974088, 0.004601159236829345, 0.003998423292435439, 0.0031628508095656012, 0.002143098918875645, 0.000998549902571999, -0.00020414675989259147, -0.0013949555301961563, -0.0025045331268035626, -0.003468266529064039, -0.004230035528339205, -0.004745480724951482, -0.004984586668665643, -0.004933429721039334, -0.004594988857967104, -0.003988972197692848, -0.0031506693559268323, -0.0021288964578253435, -0.0009831534730770743, 0.00021984059158935553, 0.0014100328795006473, 0.0025181160081788083, 0.003479563982961604, 0.004238389680425442, 0.0047504050955038644, 0.004985794501303071, 0.00493085068114494, 0.004588773128419907, 0.003979481733405056, 0.0031384568064534695, 0.002114672985426506, 0.0009677473402542858, -0.00023553225354823383, -0.0014250963123498708, -0.002531674036765689, -0.0034908270949673883, -0.004246702001316604},
/*  852 */  {0.0, 0.001322395235695022, 0.0025506132693711237, 0.0035971839296615724, 0.004387573450986485, 0.004865492554910633, 0.004996905211369746, 0.004772452587269807, 0.004208119555781073, 0.0033440962994434344, 0.0022419160804501613, 0.0009800730179144656, -0.0003515680385265205, -0.0016581714259756724, -0.002846684592626321, -0.0038324650340467482, -0.004545308289972727, -0.004934447704937684, -0.004972169884105152, -0.004655788361891959, -0.004007834924354383, -0.003074454959904806, -0.0019221211168859045, -0.0006328993118995241, 0.0007013957697786629, 0.001985739453173903, 0.003128664458861791, 0.004048774940693061, 0.004680543264880073, 0.004978976700437341, 0.004922821672646027, 0.004516077381785994, 0.0037877109915435457, 0.002789594670560921, 0.001592811405121059, 0.00028259267241012467, -0.0010477515012282026, -0.002303477813176387, -0.0033951570312588664, -0.004245042887577791, -0.004792608945086879, -0.004998859117120999, -0.004849104857023454, -0.004354011234378371, -0.0035488373992942357, -0.0024909255266974462, -0.0012556170708329134, 6.911283736778015e-05, 0.0013889207271951419, 0.002609813659994105, 0.0036448431371070584, 0.004420297322971933, 0.004880950590977764, 0.004993996534453811, 0.004751384345011787, 0.004170392168065855, 0.0032923966027920536, 0.0021799259792164923, 0.0009122072696002434, -0.0004204762296593105, -0.0017232146158725798, -0.002903230591553499, -0.0038764867978795777, -0.00457367071474697, -0.004945130899976477, -0.004964413022849068, -0.004630143865787955, -0.003966129120982182, -0.0030196580171563767, -0.0018581355161132165, -0.0005642819243674124, 0.0007697582102154628, 0.002048978369262746, 0.003182276156082912, 0.004088941347487005, 0.004704403844771129, 0.004984832171250228, 0.004910255024516547, 0.004485983575409433, 0.003742233221636691, 0.0027319717336713473, 0.0015271470418112814, 0.0002135633106056825, -0.00111522978804455, -0.002364599414641068, -0.003445569041936748, -0.004281155108422728, -0.004811849567137353, -0.004999857878369915, -0.004831790628554613, -0.004319617085964168, -0.0034998127836974036, -0.002430761836659246, -0.0011885989920796065, 0.00013821246917302972, 0.0014551808341413516, 0.002668515386999847, 0.0036918059152668326, 0.004452176597702724, 0.004895476011619269, 0.004990133642141358, 0.004729408243874503, 0.004131867933098375, 0.0032400678196949483, 0.0021175193540789007, 0.0008441672235636579, -0.0004893040793482537, -0.0017879285468470007, -0.0029592218629571477, -0.003919767871693621, -0.004601159236829353, -0.0049548692164976356, -0.004955707598791953, -0.0046036146765259965, -0.003923665499408539, -0.0029642841008052996, -0.001793794876744483, -0.000495556718078016, 0.0008379735710276055, 0.0021118257819347217, 0.003235279807847212, 0.004128326470040499, 0.004727365542464494, 0.004989735177724379, 0.004896750161690101, 0.004455032620941832, 0.003696040413877343, 0.0026738267921161294, 0.0014611908827002456, 0.00014449314272586237, -0.001182494985118631, -0.002425269206187068, -0.0034953226991281876, -0.0043164493182636324, -0.004830170777067489, -0.004999901304280686, -0.004813553177776997, -0.004284397577519784, -0.00345011945012687, -0.0023701336948830434, -0.0011213538047469137, 0.00020728569237643793, 0.0015211628960494863, 0.0027267072341026427, 0.0037380632908455345, 0.004483205183926188, 0.004909066041426734, 0.004985317272524874, 0.004706528482886533, 0.004092554211800479, 0.0031871199487434393, 0.0020547081292272276, 0.00077596588038635, -0.0005580384364841142, -0.001852300853846365, -0.003014647708445127, -0.003962299985665967, -0.004627768603919273, -0.00496366079377669, -0.004946055275300927, -0.004576205863104589, -0.0038804521732637206, -0.0029083437912841327, -0.0017291114925064301, -0.00042673682452823094, 0.000906028818135675, 0.002174269682777648, 0.003287665286614531, 0.004166922782939764, 0.00474942397061124, 0.004993684783030089, 0.004882309664574575, 0.004423230432259415, 0.0036491413944406987, 0.0026151709557945702, 0.001394955530196139, 7.539536618019365e-05, -0.0012495342399211626, -0.0024854755954857506, -0.0035444084962776424, -0.004350918773347646, -0.00484756907419793, -0.004998989386555814, -0.004794395989365921, -0.004248359438524697, -0.0033997668936120756, -0.0023090526857394373, -0.0010538943575407636, 0.0002763193089846516, 0.0015868543055620884, 0.002784378082440927, 0.003783606425330845, 0.004513377152932806, 0.004921718083719203, 0.004979548345880141, 0.00468274943374097, 0.004052458515943114, 0.003133563106819567, 0.0019915043061591144, 0.0007076162714692727},
/*  941 */  {0.0, 0.0014566835620827329, 0.002786986926630079, 0.0038754944973040766, 0.00462776860391927, 0.004978542806550401, 0.004897384337111957, 0.0043913344114632265, 0.003504297341584508, 0.002313231447752446, 0.0009214722428116672, -0.0005502328385714934, -0.001974200349050995, -0.0032268884982594947, -0.004199615497050658, -0.004807988665054385, -0.004999226242972442, -0.00475673667756528, -0.004101558085809114, -0.00309053301196161, -0.0018113768335227295, -0.00037506767554152184, 0.0010937819244120595, 0.0024677362572904883, 0.0036275926187359898, 0.004472723199190124, 0.00492980543740406, 0.00495918340187761, 0.004558308294059055, 0.0037619595791883835, 0.0026392275597253373, 0.0012875191798356997, -0.00017589288952619056, -0.0016240446932394323, -0.002931296239353545, -0.00398423188089702, -0.004691500127515944, -0.004991739196154013, -0.004858900689074064, -0.004304509523013033, -0.003376664040605124, -0.002155863053260944, -0.0007480218564832068, 0.0007247168598683393, 0.002134579971461622, 0.003359249369423179, 0.004292474139375519, 0.004853288769081491, 0.0049930376235577155, 0.00469959625224144, 0.003998423292435457, 0.0029503517070929857, 0.0016463109866226657, 0.0001994382104404269, -0.0012647375964669975, -0.002619186217983924, -0.0037463972429307994, -0.004548575133755773, -0.004956123855369347, -0.0049336849474418305, -0.004483205183926185, -0.00364376767317944, -0.002488201052242786, -0.00111676095770108, 0.00035156803852652184, 0.001789395394375476, 0.003071976855167616, 0.004088037122279841, 0.00474942397061123, 0.004998756234673846, 0.004814402132792938, 0.004212356015710587, 0.003244850715033316, 0.0019958258825831993, 0.0005736454823401094, -0.0008983037429659687, -0.002292317164341836, -0.0034874517738849777, -0.004380019061635502, -0.0048925809119478424, -0.004980668045715862, -0.0046366381240983134, -0.003890338789084047, -0.002806518116257032, -0.0014792071459132886, -2.3561857696866103e-05, 0.0014341276303084063, 0.002767393847586185, 0.0038605641440888844, 0.004618796316878295, 0.004976307011031542, 0.004902079008173812, 0.0044025522448211864, 0.003521065090863993, 0.0023340943622297506, 0.0009446202799206271, -0.0005268079760194961, -0.0019525309753029027, -0.0032088546233641907, -0.004186781719340232, -0.004801468428384711, -0.004999585235609488, -0.0047639437537189975, -0.004114987967806534, -0.0031090205386216057, -0.0018333180482056927, -0.0003985589835904038, 0.0010707786019794913, 0.0024472166623831938, 0.0036113370079074256, 0.004462141890618589, 0.004925816453302632, 0.0049621328219384316, 0.004567940229975552, 0.00377743837523172, 0.0026592102932783464, 0.001310272171821135, -0.00015234366263440897, -0.0016017423353959792, -0.002912175677582455, -0.00396995199323916, -0.004683299820670056, -0.00499032991935038, -0.004864404709554155, -0.004316449318263631, -0.00339400372766471, -0.0021770982607390325, -0.0007713102420992397, 0.0007013957697786655, 0.0021132494879652955, 0.0033417601008389553, 0.004280343434615667, 0.004847569074197918, 0.00499422517272787, 0.004707588015059392, 0.004012525912711933, 0.0029693416576442346, 0.0016685407210876955, 0.00022297910251628465, -0.0012419279276158436, -0.002599086713103547, -0.003730751712045064, -0.0045387409652058, -0.004952954250355663, -0.004937454897265338, -0.004493587612057841, -0.0036598618120453437, -0.0025086105927872083, -0.0011397151915610423, 0.00032806059439166146, 0.001767374218896297, 0.0030533524803082394, 0.0040744253774729275, 0.004742005795246974, 0.00499817522115097, 0.004820708689179267, 0.0042250029923968, 0.0032627408748064474, 0.0020174070956705866, 0.000597045387410846, -0.0008751152948763697, -0.002271351976432374, -0.0034705287618476627, -0.004368606446613108, -0.004887668839349053, -0.004982682681333659, -0.004645404680453816, -0.003905096689788029, -0.002825986982746282, -0.0015016978816285865, -4.712319216571802e-05, 0.001411539851480187, 0.0027477393142203827, 0.0038455480609903836, 0.004609721462219113, 0.004973960708808631, 0.004906664820880871, 0.004413672312599794, 0.003537754649369281, 0.0023549054444800153, 0.0009677473402542869, -0.0005033714148699262, -0.0019308182425413639, -0.0031907494908179103, -0.004173854967573465, -0.004794841567576012, -0.004999833204612987, -0.004771045039027956, -0.004128326470040508, -0.003127439024603113, -0.0018552185511852956, -0.00042204144101173506, 0.001047751501228211, 0.0024266427231906976, 0.003595001201675141, 0.00445146149318612, 0.004921718083719197, 0.004964972050055303, 0.00457747072761303, 0.0037928332873298637},
/* 1209 */  {0.0, 0.0018537597939951957, 0.0034432917970082925, 0.00454203023109331, 0.0049933651458964725, 0.004732964998616046, 0.00379794622467705, 0.002321582803785474, 0.0005143098994682061, -0.0013662707597463836, -0.003052108439908014, -0.004302910322267245, -0.004940391917429819, -0.004873689050745294, -0.004112309292273891, -0.0027647767843187497, -0.0010231636275948109, 0.0008642873372466244, 0.00262854610931626, 0.004018142029052483, 0.004835007438812176, 0.004962709484970148, 0.004383046009043132, 0.0031786400133496286, 0.0015211628960494867, -0.00035313492965583176, -0.0021770982607390325, -0.0036907463794363265, -0.004678329704802494, -0.004999081908148386, -0.004607284204107493, -0.003558781930455457, -0.00200302456845961, -0.0001617637886415924, 0.001702554179422784, 0.003324196623229133, 0.004472020866106132, 0.004982420455311871, 0.004782644996533759, 0.003901169715276392, 0.002463636707741452, 0.0006749463996880921, -0.0012099481721531624, -0.0029223813853186758, -0.0042182695960781506, -0.004912901883201182, -0.004907268032222071, -0.004202171070590087, -0.0028981128072255104, -0.0011809686912328877, 0.0007045061596879102, 0.0024895634123251508, 0.003919767871693633, 0.004791263695102274, 0.004979831219887524, 0.0044585927563474135, 0.003301843630252984, 0.0016744624128724392, -0.00019159023641045718, -0.0020303343503024762, -0.0035796824151091535, -0.004618796316878309, -0.004999564756760615, -0.004667714465872117, -0.003670546108291436, -0.002150192226332993, -0.0003233582146451375, 0.001549566033236422, 0.0032016210987842013, 0.00439732940719888, 0.004966259295211696, 0.004827317684841212, 0.004000308778823183, 0.002603111245724885, 0.0008348762479202238, -0.001052358799106541, -0.002789594670560915, -0.004129212447197753, -0.004880268163662042, -0.004935709226889315, -0.004287633280968255, -0.0030284145785577387, -0.0013375373102087593, 0.0005439873818125541, 0.0023479742047507178, 0.003817289815477934, 0.0047425036182204275, 0.0049917391961540125, 0.004529471468626461, 0.0034215902995147567, 0.0018260088094579113, -2.9844952982706594e-05, -0.001881444730616842, -0.003464870612886469, -0.004554427164810614, -0.004994813186202746, -0.004723257747415579, -0.003778467316219282, -0.002295108686760932, -0.0004846140926910047, 0.00139495553019614, 0.00307569355717975, 0.004318034054459636, 0.004944898585926092, 0.004866936292351826, 0.00409525961919919, 0.00273986039138529, 0.0009939320016162448, -0.0008936676327359364, -0.002653887320001679, -0.004035832116232018, -0.004842524925499997, -0.004958982857528051, -0.004368606446613092, -0.003155545675622044, -0.0014927055610970614, 0.000382899062763479, 0.002203926726949506, 0.003710815152365404, 0.00468877825874675, 0.004998420946416501, 0.004595607937642488, 0.0035377546493692304, 0.0019756434205216895, 0.00013193157736379743, -0.001730585285387474, -0.0033464311778516544, -0.0044852896414905976, -0.004984832171250232, -0.004773855896312266, -0.0038824325634353755, -0.0024376222258362967, -0.0006453625919109079, 0.001238884543629055, 0.002946545841400039, 0.004234217828138109, 0.0049183606915830565, 0.004901459339375137, 0.004185922825250963, 0.002873740971789757, 0.001151947133382962, -0.0007340408187207717, -0.0025154014158405356, -0.00393822637005027, -0.00479971168494077, -0.00497706455722949, -0.004445005790646814, -0.00327937299534168, -0.001646310986622648, 0.00022140985797893895, 0.0020575717930255673, 0.0036004553586635115, 0.00463014386578795, 0.004999869475049692, 0.004656932920167725, 0.003650215058649584, 0.002123209582370997, 0.0002935699786508503, -0.0015779139606777832, -0.0032244881131288606, -0.004411456132174778, -0.004969632161775915, -0.004819455937566642, -0.003982333000927949, -0.0025775836354505377, -0.0008054354126493252, 0.0010815164759518025, 0.0028143131658711932, 0.004145968481725496, 0.004886673396693779, 0.0049308506811449404, 0.004272203474870936, 0.003004612817321395, 0.001308756205332184, -0.0005736454823401453, -0.0023742819493529784, -0.003836497399425939, -0.004751873266375654, -0.004989935394906603, -0.004516751324868317, -0.0033997668936120522, -0.0017981927657494828, 5.9688842614626085e-05, 0.001909062632931701, 0.0034863259783140554, 0.004566661828085978, 0.004996083265480364, 0.0047133822104802854, 0.00375885378412191, 0.0022685527969277604, 0.0004549010195178265, -0.001423590599543682, -0.0030991690900548353, -0.004333003938699471, -0.0049492290718092975, -0.004860010129076812, -0.0040780640354393174, -0.0027148463795108662, -0.0009646649626692826, 0.0009230160875927005},
/* 1336 */  {0.0, 0.002037509151537404, 0.00372132460454785, 0.004759150780990507, 0.004970830169181504, 0.004319617085964177, 0.0029185564046626438, 0.0010108599576538662, -0.0010723129022316938, -0.0029693416576442385, -0.004350918773347628, -0.004977214592878916, -0.00473950966110591, -0.0036790674670359874, -0.0019799714644350465, 6.283019941676678e-05, 0.002094725092325179, 0.003762994101765693, 0.004778040375796961, 0.004963660793776687, 0.004287633280968262, 0.00286731027779177, 0.0009492473865704687, -0.0011335965161716095, -0.003019658017156387, -0.0043815334002193194, -0.0049828130566944105, -0.004719120117703685, -0.0036362293621219756, -0.0019221211168858974, 0.0001256504772166949, 0.002151610251738052, 0.0038040693785928547, 0.004796175462639271, 0.004955707598791949, 0.004254972408973458, 0.0028156113693891217, 0.0008874849183207026, -0.0011947011220805582, -0.0030694975376626505, -0.004411456132174765, -0.004987624676565652, -0.004697985370529095, -0.003592817054439182, -0.001863967244130465, 0.0001884509133496928, 0.0022081556469499093, 0.0038445439487669597, 0.004813553177777004, 0.00494697184012898, 0.004221639627510072, 0.0027634678433116518, 0.0008255823059142822, -0.0012556170708329156, -0.0031188523489249585, -0.0044406822440677274, -0.004991648692682083, -0.0046761087570037305, -0.0035488373992942244, -0.0018055190293393907, 0.00025122159089886276, 0.0022643523487873777, 0.0038844114208841985, 0.004830170777067485, 0.004937454897265335, 0.004187640200210698, 0.0027108879336265866, 0.0007635493244913129, -0.0013163347430942222, -0.003167714657246502, -0.004469207120756322, -0.004994884469604913, -0.004653493731698457, -0.0035042973415845024, -0.0017467857021633264, 0.0003139525976465767, 0.002320191483139751, 0.003923665499408542, 0.00484602563639916, 0.004927158273036621, 0.004152979495979065, 0.0026578799433112075, 0.0007013957697786267, -0.0013768445508401405, -0.003216076746702353, -0.004497026257831863, -0.004997331496367454, -0.004630143865787943, -0.003459203914701441, -0.0016877765372755086, 0.0003766340276397037, 0.0023756642323604395, 0.003962299985665957, 0.0048611152521059265, 0.004916083593399164, 0.004117662988142142, 0.0026044522429416127, 0.0006391314565430898, -0.001437136938870593, -0.0032639309803579415, -0.004524135262330103, -0.004998989386555816, -0.004606062846486692, -0.003413564239419884, -0.0016285008529071448, 0.0004392559827537509, 0.0024307618366592493, 0.004000308778823217, 0.00487543724136255, 0.004904232607173261, 0.004081696253585908, 0.0025506132693711198, 0.000576766217041518, -0.0014972023863186114, -0.003311269801475043, -0.004550529853424982, -0.004999857878369915, -0.004581254476466805, -0.0033673855227736305, -0.0015689680093759267, 0.0005018085742561042, 0.002485475595485796, 0.004037685876851229, 0.004888989342560901, 0.0048916071857670095, 0.004045084971874727, 0.002496371524397746, 0.0005143098994681893, -0.001557031408153676, -0.003358085734705035, -0.004576205863104603, -0.0049999368346648285, -0.004555722673257498, -0.0033206750569173336, -0.0015091874076079736, 0.0005642819243673978, 0.002539796868903238, 0.004074425377472947, 0.004901769415667107, 0.004878209322880824, 0.004007834924354376, 0.0024417355734217814, 0.00045177236639966497, -0.0016166145566797123, -0.0034043713872693782, -0.004601159236829365, -0.004999226242972442, -0.0045294714686264555, -0.0032734402179750892, -0.0014491684876533043, 0.0006266661678215407, 0.00259371707895282, 0.004110521479095324, 0.004913775442559451, 0.0048640411341925585, 0.003969951993239152, 0.002386714044093277, 0.0003891634932373039, -0.0016759424230268583, -0.00345011945012692, -0.004625386034172288, -0.004997726215503422, -0.0045025050079432645, -0.003225688464875476, -0.0013889207271950718, 0.0006889514534232047, 0.002647227711008314, 0.004145968481725456, 0.004925005527347143, 0.00484910485702345, 0.003931442160683072, 0.0023313156249495743, 0.00032649316664817607, -0.0017350056386372676, -0.003495322699128233, -0.0046488824294412786, -0.004995436989129493, -0.004474827549524563, -0.00317742733817392, -0.001328453640053272, 0.0007511279456038648, 0.0027003203151206023, 0.0041807607878707916, 0.004935457896669566, 0.004833402849984811, 0.003892311507835053, 0.0022755490640432243, 0.00026377128300306385, -0.0017937948767445127, -0.003539973996156288, -0.004671644712283054, -0.004992358925346035, -0.004446443463961977, -0.0031286644588617595, -0.0012677767746816478, 0.0008131858259744222, 0.002752986507352027, 0.004214892903422766, 0.0049451308999764855, 0.004816937592605577},
/* 1477 */  {0.0, 0.002237702956889317, 0.004002192685952383, 0.004920327668300148, 0.004797947362096908, 0.0036609318688737924, 0.0017497289969424634, -0.0005314939010674552, -0.0027003203151205767, -0.004298102530233485, -0.004986953126161618, -0.004621198963856026, -0.0032781870867223772, -0.0012419279276158354, 0.0010569651622120639, 0.003132338908433452, 0.004545308289972725, 0.00499706876720174, 0.004392085303633321, 0.0028582954240829687, 0.0007200539127612621, -0.0015704593892454475, -0.003528863304496031, -0.004741008745297644, -0.004950559965714646, -0.004113202590104304, -0.002406014896589597, -0.00019002058425720357, 0.0020661579061194302, 0.003885400274593343, 0.004882986310319122, 0.00484795373765299, 0.0037877109915435527, 0.0019264705353211752, -0.0003421659684976161, -0.0025384436894374802, -0.004197909708790421, -0.0049696321617759154, -0.00469041276873004, -0.0034192988262781543, -0.001425096312349883, 0.000870475256775883, 0.002981965017932633, 0.004462850396565585, 0.004999964469466237, 0.004479722239409778, 0.0030121407683921277, 0.0009075735655151692, -0.0013889207271951401, -0.0033916961156660193, -0.004677220154149331, -0.0049736395218876964, -0.004218269596078145, -0.002570850542275163, -0.0003797666201644925, 0.0018916275985364334, 0.003762994101765673, 0.004838589843864482, 0.004890955621015041, 0.003909017497618916, 0.0021004286420590428, -0.00015234366263439244, -0.002372899432013295, -0.004091651601377698, -0.004945130899976474, -0.0047528497020819, -0.003555470243950978, -0.0016062056683605356, 0.000682727658409621, 0.002827282680647604, 0.004373944421667251, 0.004995636049143752, 0.004560886716669616, 0.0031616340669431632, 0.0010937819244120587, -0.001205375304165178, -0.0032496284863094737, -0.004606673752627324, -0.004989532990673728, -0.004317241899408992, -0.0027319717336713495, -0.0005689639560489756, 0.0017143642015996544, 0.0036351510241657394, 0.004787202414495272, 0.00492689088156617, 0.004024676119240319, 0.0022713519764323894, 3.769875465180173e-05, -0.0022039267269494587, -0.003979481733405068, -0.004913484741038616, -0.004808419552858482, -0.0036865045945398962, -0.001784994322550388, 0.0004939936313740815, 0.002668515386999844, 0.0042787188197228355, 0.004984089760086527, 0.0046354614661528485, 0.003306559326618284, 0.0012784099491378498, -0.0010200883129673588, -0.0031028656806790815, -0.004529471468626469, -0.004998217408636191, -0.004409976501470269, -0.00288914567727633, -0.0007573392330185706, 0.001534623831631006, 0.003502055753919023, 0.004728898268556929, 0.004955707598791957, 0.0041345197488080986, 0.00243899358246227, 0.00022768670346595864, -0.002031769711887981, -0.0038615621717995345, -0.004874739408433559, -0.00485704203180639, -0.0038122125550572555, -0.0019612039548527844, 0.0003045458651566409, 0.002505892529497788, 0.004177311175994391, 0.004965342284774629, 0.0047033387396673565, 0.003446707154361114, 0.0014611908827002842, -0.0008333274626916203, -0.00295161974678147, -0.004445724846692117, -0.004999680228225928, -0.0044963394160831725, -0.0030421452827092167, -0.0009446202799206338, 0.0013526661837692565, 0.0033639005917015987, 0.004663761645907604, 0.004977364137296958, 0.004238389680425445, 0.0026031112457248914, 0.00041734568261093377, -0.0018566771252725473, -0.0037380632908455423, -0.004828950882765606, -0.004898646887476747, -0.003932412498268982, -0.00213457997146162, 0.00011465808047973237, 0.0023396490713028387, 0.004069868007772955, 0.004939420710212501, 0.0047644204657672756, 0.003581875059715202, 0.0016418606368484962, -0.0006453625919109018, -0.0027961092100029245, -0.004355554886856741, -0.004993919335910318, -0.004576205863104592, -0.003190749490817943, -0.001130536506584079, 0.001168754156753318, 0.003220885148897552, 0.004591886658205424, 0.00499182920696104, 0.004336135839202027, 0.0027634678433116756, 0.0006064016661965275, -0.0016789019469629141, -0.003609163526022054, -0.0047761853208893555, -0.004933174007726865, -0.004046930755115982, -0.0023048718726773236, -7.539536618021814e-05, 0.002170025206746008, 0.003956544552685393, 0.0049063624887927485, 0.004818618391450058, 0.003711867747389066, 0.001820158173637145, -0.0004564652788087103, -0.002636558757376375, -0.004259091869814867, -0.004980943055226962, -0.004649460448713766, -0.0033347435930735888, -0.0013148192947776117, 0.0009831534730770143, 0.003073216059193378, 0.0045133771529328025, 0.004999081908148386, 0.0044276169980875775, 0.002919831686432466, 0.0007945814995613934, -0.0014987010327203992, -0.003475049116193051, -0.004716518960324043},
};
float     sine_sum = 0.0;
float   cosine_sum = 0.0;
volatile uint8_t position = 255;
volatile uint16_t best;
const char dtmf_lut[16] = "123A456B789C*0#D";
uint8_t lastpos = 0;
uint8_t ringing = 0;
volatile uint8_t last_dc = 0;

volatile uint8_t at_mode = 0;
char at_buf[40];
volatile uint8_t at_buflen = 0;
volatile uint8_t at_idx = 0;
volatile uint8_t action = 0;

uint8_t samples_since_ring = 254;       // 254 = idle state (not ringing); 255 = ringing; 0-253 = ringing ended
uint8_t ring_counter = 0;
uint16_t time_since_last_ring = 0;
uint16_t await_dial_tone_timer = 0;


void printnum_noblock(uint16_t num, uint8_t bits, uint8_t offset) {
    for (uint8_t x=0; x<bits; x++) {
        txbuf[x+offset] = ((num & (1<<(bits-1)))?'1':'0');
        num = num << 1;
    }
    txbuf[offset + bits] = '\r';
    txbuf[offset + bits + 1] = '\n';
    UDR0 = txbuf[0];
    txbuflen = offset + bits + 2;
    txidx = 1;
}

void print_txbuf() {
    txidx = 1;
    UDR0 = txbuf[0];
}

void printdec(uint32_t num, uint8_t digits, uint8_t offset) {
    for (uint8_t x=0; x<digits; x++) {
        txbuf[offset+digits-1-x] = '0' + (num % 10);
        num = num / 10;
    }
}

void print_hex(uint8_t num) {
    UDR0 = (num >> 4) + (num >= 160?('A'-10):'0');
    while (!(UCSR0A & 0b00100000));
    UDR0 = (num & 0x0f) + ((num & 0x0f) >= 10?('A'-10):'0');
    while (!(UCSR0A & 0b00100000));
}

void print_char(char x) {
    txbuflen = 0;
    UDR0 = x;
    while (!(UCSR0A & 0b00100000));
}

void newline_block() {
    UDR0 = '\r';
    while (!(UCSR0A & 0b00100000));
    UDR0 = '\n';
    while (!(UCSR0A & 0b00100000));
}

void cmd(char* command) {
    strcpy(at_buf, command);
    at_buflen = strlen(command);
    UDR3 = at_buf[0];
    at_idx = 1;
    while (at_buflen);
}

void print_str(char* string) {
    strcpy(txbuf, string);
    txbuflen = strlen(string);
    UDR0 = txbuf[0];
    txidx = 1;
    while (txbuflen);
}

void start_read(uint32_t address) {
    PORTB &= 0b11111110;
    SPDR   = 0x03;
    while (!(SPSR & 0b10000000));
    SPDR   = (address >> 16) & 0xff;
    while (!(SPSR & 0b10000000));
    SPDR   = (address >> 8) & 0xff;
    while (!(SPSR & 0b10000000));
    SPDR   = (address) & 0xff;
    while (!(SPSR & 0b10000000));
}

uint8_t next_byte() {
    SPDR = 0;
    while (!(SPSR & 0b10000000));
    return SPDR;
}

uint32_t next_long(uint8_t offset) {
    return *((uint32_t*)(data+offset));
}

void end_read() {
    PORTB |= 0b00000001;
}

void delay_us(uint16_t us) {
    TCCR3B = 0b00000010;    // divide by 8
    OCR3A  = 2*us-1;             // 1us
    TCNT3  = 0;
    TIFR3 |= 0b00000010;
    while (!(TIFR3 & 0b00000010));
}

void delay_ms(uint16_t ms) {
    TCCR3B = 0b00000011;    // divide by 64
    OCR3A  = 249;           // 1ms
    TCNT3  = 0;
    TIFR3 |= 0b00000010;
    for (; ms>0; ms--) {
        while (!(TIFR3 & 0b00000010));
        TIFR3 |= 0b00000010;
    }
}

void wait_secs(uint8_t secs) {
    waiting = 1;
    TCCR3B = 0b00001101;
    OCR3A  = (F_CPU/1024L - 1);
    TIFR3 |= 0b00000010;
    TCNT3  = 0;
    for (; secs>0; secs--) {
        while(!(TIFR3 & 0b00000010));
        TIFR3 |= 0b00000010;
    }
    waiting = 0;
}

void send_nibble(uint8_t byte) {
    uint8_t temp = TCCR3B;
    
    
    PORTL  = byte | 0b00000001 | (PORTL & 0b00001000);
    delay_us(2);
    
    PORTL  = byte | (PORTL & 0b00001000);
    delay_us(40);
    
    TCCR3B = temp;
}


void send(uint8_t byte, uint8_t rs) {
    if (!waiting) {
        send_nibble((byte & 0xf0) | (rs?0x02:0x00));
        byte = byte << 4;
        send_nibble((byte & 0xf0) | (rs?0x02:0x00));
    }
}

void send_from_txbuf() {
    if (!waiting) {
        uint8_t n = 0;
        for (n=0; n<lcdbuflen; n++) {
            send(lcdbuf[n], 1);
        }
    }
}

void send_from_string(char* text, uint8_t len) {
    if (!waiting) {
        uint8_t n=0;
        for (n=0; n<len; n++) {
            send(text[n], 1);
        }
    }
}

void enable_dtmf() {
    ADMUX  = 0b11100000;            // Select A0
    ADCSRA |= 0b01000000;           // Start conversion
    ADCSRA &= 0b11110111;
    while (!(ADCSRA & 0b00010000)); // Await completion
    ADCSRA |= 0b00011000;           // Clear flag to prevent erroneous triggers
    last_dc = ADCH;
    ADMUX  = 0b11101001;            // Select 10*(A1-A0)  */
    
    adc_sample_num = 0;
    TIFR0 |= 0b00000010;
    TIMSK0 = 0b00000010;
    PORTB |= 0b10000000;
}

void disable_dtmf() {
    TIMSK0 = 0b00000000;
    PORTB &= 0b01111111;
}


ISR(ADC_vect) {
    data[adc_sample_num] = 4*ADCH;
    //if (ADCH > 128) data[adc_sample_num] = -ADCH;
    adc_sample_num++;
    if (adc_sample_num >= NDTMFSAMPLES) {
        disable_dtmf();
        //PORTB &= 0b01111111;
    }
}

ISR(TIMER0_COMPA_vect) {
    ADCSRA |= 0b01000000;
}

// Audio playback
ISR(TIMER5_COMPA_vect) {
    uint8_t s=0, n=0;
    PORTB |= 0b01000000;
    for (; n<bytes_per_sample; n++) {
        s = next_byte();
        curr_sample++;
        if (curr_sample >= data_lengths[curr_chunk]) {
            // End of chunk
            curr_chunk++;
            curr_sample = 0;
            if (curr_chunk >= data_chunks) {
                // End of playback
                TIMSK5 = 0b00000000;
                end_read();
                TIFR5 |= 0b00000010;
                PORTB &= 0b01111111;
                enable_dtmf();
                finished = 1;
                return;
            }
            end_read();
            start_read(data_offsets[curr_chunk]);
            
            return;
        }
    }
    PORTA = s*volumes[curr_chunk]+128;
    PORTB &= 0b10111111;
}



ISR(TIMER4_COMPA_vect) {
    if (DDRK == 0b00001000) {
        DDRK  = 0b00000001;
        // Do actions based on keyboard
        uint16_t mask_diff = ~lastmask & mask;
        lastmask = mask;
        
        txbuflen = 0;
        
        if (flags & 0b00001000) {
            if (mask_diff & 0x8000) {
                // Start set1 and the set1_to_afterBreakfast timer
                timer_states |= 0b00100001;
                //flags |= 0b00000001;
                set1 = TIME(0, 30, 0);
                set1_to_afterBreakfast = 3600*1.5;
                send(0x80, 0);
                send_from_string("carba + mido", 12);
                flags |= 0b00000110;
                recv = 'd';         // Dial the telephone
                action = 1;         // Play 1 once connection is established
                strcpy(txbuf, "start 1 -----\r\n");
                txbuflen = 15;
                printdec(currentTime, 5, 8);
                print_txbuf();
            } /*else if (mask_diff & 0x2000) {
                // start set 3 (before dinner)
                timer_states |= 0b00010000;
                beforeDinner = 3600*0.5;
                send(0x80, 0);
                send_from_string("omir           ", 15);
                flags |= 0b00000110;
            } else if (mask_diff & 0x4000) {
                // start set 2 (after breakfast)
                timer_states |= 0b00000100;
                afterBreakfast = 3600*6;
                send(0x80, 0);
                send_from_string("gab + AM reg   ", 15);
                flags |= 0b00000110;
            }*/ else if (mask_diff & 0x0008) {
                flags &= 0b11111011;
                //PORTB |= 0b10000000;
            }
        } else {
            uint8_t n = 16;
            char l;
            do {
                n--;
                l = symlut[n];
                if ((mask_diff & 1) && (l >= '0') && (l <= '9')) {
                    send(l, 1);
                    time_in_buf[time_in_buflen] = l;
                    time_in_buflen++;
                    if (time_in_buflen == 2) send(':', 1);
                    txbuflen = 0;
                    UDR0 = l;
                    break;
                }
                mask_diff = mask_diff >> 1;
            } while (n > 0);
            if (time_in_buflen == 4) {
                flags |= 0b00001000;
                currentTime = 36000UL*time_in_buf[0] + 3600UL*time_in_buf[1] + 600*time_in_buf[2] + 60*time_in_buf[3];
                send(0x80 | 0x40, 0);
                send_from_string("Next in 00:00:00", 16);
            }
        }
        
        if (mask_diff) {
            OCR2A = BACKLIGHT_BRIGHT;
            flags |= 0b00000010;
        }
        
        
        uint8_t n = 16;
        txbuflen = 0;
        do {
            n--;
            if (mask_diff & 1) {
                UDR0 = symlut[n];
                while (!(UCSR0A & 0b00100000));
                newline_block();
            }
            mask_diff = mask_diff >> 1;
        } while (n > 0);
        mask = 0;
        

        
        if (flags & 0b00001000) {
            // A temporary solution:
            // Whenever the column counter for
            // the keypad overflows, write the
            // time. This will be better than
            // doing it it the "second" counter.
            
            //strcpy(txbuf, "s1 0, bd 0, ab 0, sab 0\r\n");
            uint32_t temp_time = set1;
            if (set1 > 0) txbuf[3] = '1';
            if ( (beforeDinner > 0) && ((beforeDinner < temp_time) || (temp_time == 0)) ) {
                temp_time = beforeDinner;
                //txbuf[9] = '1';
            }
            if ( (afterBreakfast > 0) && ((afterBreakfast < temp_time) || (temp_time == 0)) ) {
                temp_time = afterBreakfast;
                //txbuf[15] = '1';
            }
            if ( (set1_to_afterBreakfast > 0) && ((set1_to_afterBreakfast < temp_time) || (temp_time == 0)) ) {
                temp_time = set1_to_afterBreakfast;
                //txbuf[22] = '1';
            }
            //txbuflen = 25;
            //if (temp_time >= TIME(10, 0, 0)) print_txbuf();
            
            
            
            uint8_t hours = temp_time/3600;
            uint8_t seconds = temp_time%60;
            uint8_t minutes = (temp_time%3600)/60;
            /*uint8_t thours = currentTime/3600;
            uint8_t tseconds = currentTime%60;
            uint8_t tminutes = (currentTime%3600)/60;*/
            lcdbuf[0] = hours/10 + '0';
            lcdbuf[1] = hours%10 + '0';
            lcdbuf[2] = ':';
            lcdbuf[3] = minutes/10 + '0';
            lcdbuf[4] = minutes%10 + '0';
            lcdbuf[5] = ':';
            lcdbuf[6] = seconds/10 + '0';
            lcdbuf[7] = seconds%10 + '0';
            
            /*lcdbuf[8] = thours/10 + '0';
            lcdbuf[9] = thours%10 + '0';
            lcdbuf[10] = ':';
            lcdbuf[11] = tminutes/10 + '0';
            lcdbuf[12] = tminutes%10 + '0';
            lcdbuf[13] = ':';
            lcdbuf[14] = tseconds/10 + '0';
            lcdbuf[15] = tseconds%10 + '0';*/
            lcdbuflen = 8;
            send(0x80 | 0x48, 0);
            send_from_txbuf();
        }
        
    } else {
        DDRK  = DDRK << 1;
    }
    PORTK = ~DDRK;
    
    // TODO: move to other ISR
    if (flags & 0b00000010) {
        if (backlight_timer == 100*BACKLIGHT_ON) {
            OCR2A = BACKLIGHT_DIM;
            backlight_timer = 0;
            flags &= 0b11111101;
        }
        backlight_timer ++;
    }
    
    // TODO: move to other ISR
    if (flags & 0b00000100) {
        /*if (buzzer_timer % (uint16_t)(100*BUZZER_PERIOD) < (uint16_t)(100*BUZZER_ON))
            PORTB &= 0b01111111;
        else
            PORTB |= 0b10000000;*/
        
        if (buzzer_timer == 100*BUZZER_TOTAL) {
            flags &= 0b11111011;
            buzzer_timer = 0;
            //PORTB |= 0b10000000;
        }
        buzzer_timer ++;
    }
    
    if (flags & 0b00010000) {
        call_timer ++;
    }
    
    if (flags & 0b00100000) {
        time_since_last_ring++;
    }
    
    if (flags & 0b01000000) {
        await_dial_tone_timer++;
    }
}

ISR(TIMER4_COMPB_vect) {
    uint8_t inp = ~PINK;
    uint16_t col = (inp & 0b00001111) << 12;
    //mask |= col;
    //printnum_noblock(inp, 8, 0);
    uint8_t _r = 4;
    inp = inp >> 4;
    while (_r > 0) {
        _r--;
        if (inp & (1<<_r)) {
            mask |= col;
        }
        col = col >> 4;
   }
}

ISR(USART0_TX_vect) {
    if (txidx < txbuflen) {
        UDR0 = txbuf[txidx];
        txidx++;
        PORTB |= 0b10000000;
        delay_us(txidx*4);
        PORTB &= 0b01111111;
    } else txbuflen = 0;
}

ISR(USART0_RX_vect) {
    txbuflen = 0;
    recv = UDR0;
    if (at_mode) {
        UDR0 = recv;
        if (recv == '\e') {
            at_buflen = 0;
            newline_block();
            print_char('>');
        } else {
            at_buf[at_buflen] = recv;
            at_buflen++;
        }
        if (recv == '\r') {
            at_buf[at_buflen] = '\n';
            at_buflen++;
            UDR3 = at_buf[0];
            at_idx = 1;
            at_mode = 0;
            while (!(UCSR0A & 0b00100000));
            UDR0 = '\n';
        } else if (recv == 127) {
            at_mode = 0;
            newline_block();
        }
        recv = 0;                   // suppress playback
    } if (recv == 'x') {
        recv = 0;                   // suppress playback
        enable_dtmf();
        //PORTB |= 0b10000000;
    } else if (recv == '\r') {
        newline_block();
    } else if (recv == '\e') {
        at_mode = 1;
        UDR0 = '>';
        recv = 0;                   // suppress playback
    }
}

// Runs every second (or every 1/1024 second in test mode)
ISR(TIMER1_COMPA_vect) {
    if (!waiting) {
        if (timer_states & 0b00000011) {
            set1 --;
            if (set1 == 0) {
                OCR2A = BACKLIGHT_BRIGHT;
                flags |= 0b00000110;
                send(0x80, 0);
                switch (timer_states & 0b00000011) {
                    case 0b01:
                        // 30m:     breakfast
                        send_from_string("breakfast      ", 15);
                        timer_states = (timer_states & 0b11111100) | 0b10;
                        set1 = 3600*4;
                        //recv = 'd';         // just a test
                        //action = 2;
                        break;
                    case 0b10:
                        // 4h30m:   carba + mido + eset
                        send_from_string("carba,mido,eset", 15);
                        timer_states = (timer_states & 0b11111100) | 0b11;
                        // Next dose of carba+omir must be after 17:30
                        set1 = TIME(17, 30, 0) - currentTime;
                        if (set1 < TIME(4, 30, 0)) set1 = TIME(4, 30, 0);
#ifndef TEST
                        recv = 'd';         // Dial the telephone
                        action = 3;         // Play 1 once connection is established
#endif
                        break;
                    case 0b11:
                        // 9h: carba (spaces to clear display)
                        send_from_string("carba,omir     ", 16);
                        timer_states &= 0b11111100;
#ifndef TEST
                        recv = 'd';         // Dial the telephone
                        action = 5;         // Play 1 once connection is established
#endif
                        break;
                }
            }
            if (timer_states & 0b00100000) {
                set1_to_afterBreakfast --;
                if (currentTime == TIME(10, 30, 0)) {
                    strcpy(txbuf, "autostart\r\n");
                    txbuflen = 11;
                    print_txbuf();
                }
                if (set1_to_afterBreakfast == 0 || currentTime == TIME(10, 30, 0)) {
                    // Set 2 starts either 1.5 hours after set 1, or at 10:30, whichever comes first
                    timer_states |= 0b00000100;     // start afterBreakfast
                    timer_states &= 0b11011111;     // stop set1_to_afterBreakfast
                    afterBreakfast = TIME(16, 0, 0) - currentTime;                          // At least 16:00:00
                    if (afterBreakfast < TIME(6, 0, 0)) afterBreakfast = TIME(6, 0, 0);     // At least 6 hours
                    if (afterBreakfast > TIME(7, 0, 0)) afterBreakfast = TIME(7, 0, 0);     // But at most 7 hours
                    strcpy(txbuf, "to next -----\r\n");
                    txbuflen = 15;
                    printdec(afterBreakfast, 5, 8);
                    print_txbuf();
                    send(0x80, 0);
                    send_from_string("gab + AM reg   ", 15);
                    flags |= 0b00000110;
#ifndef TEST
                    recv = 'd';         // Dial the telephone
                    action = 2;         // Play 1 once connection is established
#endif
                }
            }
        }
        if (timer_states & 0b00001100) {
            if (afterBreakfast > 0) afterBreakfast --;
            if (afterBreakfast == 0) {
                send(0x80, 0);
                switch (timer_states & 0b00001100) {
                    case 0b0100:
                        // 6h:      gab
                        strcpy(txbuf, "gab -----\r\n");
                        txbuflen = 11;
                        printdec(currentTime, 5, 4);
                        print_txbuf();
                        OCR2A = BACKLIGHT_BRIGHT;
                        flags |= 0b00000110;
                        send_from_string("gab            ", 15);
                        timer_states = (timer_states & 0b10110011) | 0b1000;
                        afterBreakfast = 3600*6;
#ifndef TEST
                        recv = 'd';         // Dial the telephone
                        action = 4;         // Play 1 once connection is established
#endif
                        break;
                    case 0b1000:
                        // 12h:     gab + PM reg
                        strcpy(txbuf, "gab+p -----\r\n");
                        txbuflen = 13;
                        printdec(currentTime, 5, 6);
                        print_txbuf();
                        OCR2A = BACKLIGHT_BRIGHT;
                        flags |= 0b00000110;
                        send_from_string("gab + PM reg   ", 15);
                        timer_states = (timer_states & 0b11110011) | 0b1100;
                        afterBreakfast = 3600*0.5;
#ifndef TEST
                        recv = 'd';         // Dial the telephone
                        action = 6;         // Play 1 once connection is established
#endif
                        break;
                    case 0b1100:
                        // 12h30m:  clon
                        strcpy(txbuf, "clon -----\r\n");
                        txbuflen = 12;
                        printdec(currentTime, 5, 5);
                        print_txbuf();
                        OCR2A = BACKLIGHT_BRIGHT;
                        flags |= 0b00000110;
                        send_from_string("clon           ", 15);
                        timer_states = 0b00000000;       // clon is always last
                        afterBreakfast = 0;
                        set1 = 0;
                        set1_to_afterBreakfast = 0;
#ifndef TEST
                        recv = 'd';         // Dial the telephone
                        action = 7;         // Play 1 once connection is established
#endif
                        break;
                }
            }
        }
    }
    currentTime = (currentTime+1)%(3600UL*24);
}


ISR(USART3_RX_vect) {
    txbuflen = 0;
    UDR0 = UDR3;
}

ISR(USART3_TX_vect) {
    if (at_idx < at_buflen) {
        UDR3 = at_buf[at_idx];
        at_idx++;
    } else at_buflen=0;
}


void prepare_audio(uint32_t offset, uint8_t vol) {
    printnum_noblock(SPCR, 8, 0);
    while (txbuflen);
    
    start_read(offset);
    uint8_t n=0;
    cli();
    for (n=0; n<36; n++) {
        data[n] = next_byte();
        print_hex(data[n]);
    }
    sei();
    
    
    sample_rate = next_long(24);
    riff_len = next_long(4);
    fmt_len = next_long(16);
    
    bytes_per_sample = (data[34]+256UL*data[35])/8;
    
    memcpy(txbuf, "\r\nSR: \0\0\0\0\0\r\n", 13);
    printdec(sample_rate, 5, 6);
    txbuflen = 13;
    print_txbuf();
    while (txbuflen);
    strcpy(txbuf, "SS: --\r\n");
    printdec(bytes_per_sample, 2, 4);
    txbuflen = 8;
    print_txbuf();
    while (txbuflen);
    strcpy(txbuf, "total length: ------\r\n");
    printdec(riff_len, 6, 14);
    txbuflen = 22;
    print_txbuf();
    while (txbuflen);
    strcpy(txbuf, "fmt length: -----\r\n");
    printdec(fmt_len, 5, 12);
    txbuflen = 19;
    print_txbuf();
    while (txbuflen);
    
    end_read();
    
    // Prepare for audio playback
    uint32_t x=36;
    while (x < riff_len + 8) {
        start_read(offset+x);
        print_hex(x>>16);
        print_hex(x>>8);
        print_hex(x);
        print_char(':');
        print_char(' ');
        for (n=0; n<8; n++) {
            data[n] = next_byte();
            if (n<4) print_char(data[n]);
        }
        newline_block();
        data_lengths[data_chunks] = next_long(4);
        if (memcmp(data, "data", 4)==0) {
            data_offsets[data_chunks] = offset + x + 8;
            x = x + 8 + data_lengths[data_chunks];
            
            strcpy(txbuf, "chunk found, len ------\r\n");
            printdec(data_lengths[data_chunks], 6, 17);
            txbuflen = 25;
            print_txbuf();
            while (txbuflen);
            volumes[data_chunks] = vol;
            data_chunks++;
        } else x = x+8+data_lengths[data_chunks];
        end_read();
    }
    
    /*strcpy(txbuf, "chunk 0 has len ------\r\n");
    printdec(data_lengths[0], 6, 16);
    txbuflen = 24;
    print_txbuf();
    while (txbuflen);*/
}

void play_audio() {
    // Begin audio playback
    disable_dtmf();
    curr_chunk = 0;
    curr_sample = 0;
    finished = 0;
    PORTB |= 0b10000000;
    start_read(data_offsets[0]);
    TIFR5  = 0b00000010;
    TIMSK5 = 0b00000010;
}


int main() {
    DDRB  |= 0b11010111;
    DDRA   = 0b11111111;
    DDRL   = 0b11111011;
    PORTB |= 0b00000001;
    PORTA  = 128;
    PORTL  = 0b00000000;

    DDRK   = 0b00000001;
    PORTK  = 0b11111111;
    
    SPCR   = 0b01010000;    // master, 8MHz
    SPSR   = 0b00000001;    // Double speed
    
    // Timer for checking keypad
    TCCR4A = 0b00000000;
    TCCR4B = 0b00001100;
    TCCR4C = 0b00000000;
    TIMSK4 = 0b00000110;
    OCR4A  = 624;
    OCR4B  = 312;
    
    // misc. delay counter
    TCCR3A = 0b00000000;
    TCCR3B = 0b00001010;    // divide by 8, CTC mode
    TCCR3C = 0b00000000;
    
    // Time keeping counter
    TCCR1A = 0b00000000;
#ifdef TEST
    TCCR1B = 0b00001001;    // divide by 1 (00001001) for faster testing
#else
    TCCR1B = 0b00001101;    // divide by 1024 (00001101)
#endif
    TCCR1C = 0b00000000;
    TIMSK1 = 0b00000010;
    OCR1A  = 15624;         // Will trigger COMPA once a second
    
    UBRR0  = 3;             // 500K UART connection to computer
    UCSR0A = 0b00000010;
    UCSR0B = 0b11011000;
    UCSR0C = 0b00000110;
    
    UBRR3  = 103;           // 19.2K serial port to communicate with telephone
    UCSR3A = 0b00000010;
    UCSR3B = 0b11011000;
    UCSR3C = 0b00000110;
    
    TCCR2A = 0b10000011;    // PWM for backlight
    TCCR2B = 0b00000010;
    OCR2A  = 31;
    
    TCCR0A = 0b00000010;    // Samples for DTMF
    TCCR0B = 0b00000010;
    OCR0A  = 99;
    
    TCCR5A = 0b00000000;    // Timer for playing back audio samples
    TCCR5B = 0b00001001;
    TCCR5C = 0b00000000;
    OCR5A  = 363;           // ~44100Hz
    TIMSK5 = 0b00000000;
    
    ADMUX  = 0b11101001;
    ADCSRA = 0b10001100;
    ADCSRB = 0b00000011;
    
    sei();
    
    strcpy(txbuf, "## RESETTING ##\r\n");
    txbuflen = 17;
    print_txbuf();
    while(txbuflen);
    
    prepare_audio(0x000000, 4);    // "It is time for pill box number ..."
    enable_dtmf();
    
    
    send_nibble(0x30);          // init
    delay_ms(8);
    
    send_nibble(0x30);          // init
    delay_us(128);
    
    send_nibble(0x30);          // init
    delay_us(128);
    
    send_nibble(0x20);          // 4-bit mode
    send(0x28, 0);
    send(0x0c, 0);              // Enable the screen
    send(0x01, 0);              // clear the screen
    
    delay_ms(8);
    send(0x06, 0);
    
    send(0x80 | 0x40, 0);
    send_from_string("Set time: 00:00", 15);
    send(0x80 | 0x4A, 0);
    
    
    while (1) {
        if (flags & 0b00000001) {
            send_from_txbuf();
            flags &= 0b11111110;
        }
        
        if (recv) {
            if (('1' <= recv) && (recv <= '7')) {
                strcpy(txbuf, "received: -\r\n");
                txbuf[10] = recv;
                txbuflen = 13;
                print_txbuf();
                while (txbuflen);
                
                data_chunks = 1;
                prepare_audio(0x030000 + 0x010000*(recv-'1'), 1);
                play_audio();
                recv = 0;
            }
        }
        if (adc_sample_num == NDTMFSAMPLES) {
            uint8_t x=0, f=0;
#ifdef DTMF_DEBUG
            strcpy(txbuf, "    ,    ;    ,    ;    ,    \r\n");
#endif
            // Generate sines and cosines
            ringing = 1;
            for (; f<NFREQ; f++) {
                sine_sum=0.0;
                cosine_sum=0.0;
                for (x=0; x<NDTMFSAMPLES; x++) {
                    vx = pgm_read_float(&(cosines[f][x]));
                    vy = pgm_read_float(&(sines[f][x]));
                    sine_sum += vy*data[x];
                    cosine_sum += vx*data[x];
                }
                sine_sum = sine_sum*sine_sum + cosine_sum*cosine_sum;
                
                /*strcpy(txbuf, "complete, ---- is -----\r\n");
                txbuflen = 25;
                printdec(freqs[f], 4, 10);
                printdec((uint32_t)sine_sum, 5, 18);
                print_txbuf();*/
                uint16_t curr = (uint16_t)sine_sum;
                // Identify the row or column
                if ((f == 6) || (f == 2)) best = 100;       // Switching from rows to columns
                if ((f == 2) && ringing) break;             // If ringing is detected, don't bother with other frequencies because they will be affected.
                if (f < 2) {
                    // ringback tones
                    if (curr < 100) ringing = 0;
                } else if (f < 6) {
                    // row DTMF tones
                    if (curr > best) {
                        best = curr;
                        position = (position & 0b00110011) | ((f-2) << 2);
                    }
                } else if (f < 9) {
                    // column DTMF tones
                    if (curr > best) {
                        best = curr;
                        position = (position & 0b11001100) | (f - 6);
                    }
                }
                //while (txbuflen);
#ifdef DTMF_DEBUG
                if (f < 2) printdec(curr, 4, 5*(f));        // Ringback tone
                if (f == 5) printdec(curr, 4, 10);          // row and columns for star
                if (f == 6) printdec(curr, 4, 15);
#endif
                
            }
            
            //for (x=0; x<NDTMFSAMPLES; x++) {
            //    print_hex(data[x]);
            //}
            //newline_block();
#ifdef DTMF_DEBUG
            printdec(last_dc, 4, 25);
            txbuflen=32;
            print_txbuf();
            while(txbuflen);
#endif
            strcpy(txbuf, "-----,-----,-----,-----\r\n");
            printdec(set1, 5, 0);
            printdec(beforeDinner, 5, 6);
            printdec(afterBreakfast, 5, 12);
            printdec(set1_to_afterBreakfast, 5, 18);
            txbuflen = 25;
            print_txbuf();
            while(txbuflen);
            
            if ((!(position & 0b11110000)) && (position != lastpos)) {
                strcpy(txbuf, "\r\nMost likely \"-\"\r\n");
                txbuflen = 19;
                txbuf[15] = dtmf_lut[position];
                print_txbuf();
                if (dtmf_lut[position] == '*') {
                    play_audio();
                    while (!finished);       // prevent DTMF being re-enabled
                }
                while (txbuflen);
            }
            if (ringing) {
                if (samples_since_ring == 254) print_str("\x1b[32mBegin of ring\x1b[0m\r\n");
                //print_str("ringing detected\r\n");
                samples_since_ring = 255;
            } else {
                if (samples_since_ring == 255) samples_since_ring = 0;
                if (samples_since_ring != 254) {
                    if (samples_since_ring >= MAX_SAMPLES_SINCE_RING) {
                        print_str("\x1b[31mEnd of ring\x1b[0m\r\n");
                        samples_since_ring = 254;
                        // Only if dialling is in progress. If the user-picked-up timer has elapsed, then the used has picked up
                        if (flags & 0b00010000) {
                            flags |= 0b00100000;
                            time_since_last_ring = 0;
                            if (ring_counter >= MAX_RINGS) {
                                // Hang up the call because the user has not picked up
                                print_str("User has not picked up\r\n");
                                call_timer = 100*AUTO_HANGUP;
                                ring_counter = 0;
                            }
                            ring_counter++;
                        }
                    } else samples_since_ring++;
                }
            }
                
            lastpos = position;
            position = 255;
            
            
            /*for(x=0; x<200; x++) { 
                print_hex(sines[x]);
            }*/
            adc_sample_num = 0;
            enable_dtmf();
            
            if (flags & 0b01000000) {
                print_str("awaiting dial tone\r\n");
                if (await_dial_tone_timer > 200) {
                    print_str("timer elapsed\r\n");
                    disable_dtmf();
                    cmd("key 13\r\n");
                    if (samples_since_ring == 255) {
                        // If the dial tone is detected after the timer has elapsed, continue
                        wait_secs(2);
                        cmd("key 4\r\n");
                        wait_secs(4);
                        cmd("key 2\r\n");
                        wait_secs(3);
                        cmd("key 3\r\n");
                        wait_secs(3);
                        cmd("key 12\r\n");
                        wait_secs(5);
                        
                        
                        enable_dtmf();
                        
                        
                        recv = 0;
                        
                        strcpy(txbuf, "done, playing -\r\n");
                        flags |= 0b00010000;                    // Begin countdown to hangup
                        //if (action) recv = '0' + action;
                        txbuf[14] = recv;
                        txbuflen = 17;
                        print_txbuf();
                        //action = 0;
                    }
                    flags &= 0b10111111;
                    await_dial_tone_timer = 0;
                }
                enable_dtmf();
            }
        }
        if (recv == 'd') {
            
            // Power-cycle handset
            // Wait 6sec
            // Enter phonebook (left, key 4)
            // Wait 4sec
            // down (key 2)
            // Wait 3sec
            // right (key 3), to abort down
            // Wait 3sec
            // Dial number (SP-PHONE, key 12)
            
            disable_dtmf();
            
            txbuflen = 0;
            at_buflen = 0;
            while (!(UCSR0A & 0b00100000));
            while (!(UCSR3A & 0b00100000));
            
            strcpy(txbuf,  "dialling\r\n");
            txbuflen = 10;
            print_txbuf();
            while (txbuflen);
            
            PORTL &= 0b11110111;
            wait_secs(2);
            DDRB  |= 0b00001000;
            PORTL |= 0b00001000;
            
            wait_secs(10);
            cmd("key 12\r\n");
            enable_dtmf();
            flags |= 0b01000000;
            recv = 0;
        } else if (recv == 'p') {
            // Power-cycle the handset
            PORTL &= 0b11110111;
            print_str("power-cycling\r\n");
            wait_secs(2);
            DDRB  |= 0b00001000;
            PORTL |= 0b00001000;
            print_str("on\r\n");
            recv = 0;
        } else if (recv == 'P') {
            PORTL &= 0b11110111;
            print_str("off\r\n");
            recv = 0;
        } else if (recv == 'h') {
            cmd("key 13\r\n");
            recv = 0;
        }
        
        
        if (flags & 0b00010000 && call_timer >= 100*AUTO_HANGUP) {
            cmd("key 13\r\n");
            wait_secs(2);
            PORTL &= 0b11110111;
            print_str("off\r\n");
            flags &= 0b11101111;
            call_timer = 0;
            enable_dtmf();
        }
        
        if (flags & 0b00100000 && time_since_last_ring >= 100*MAX_TIME_SINCE_RING) {
            flags &= 0b11011111;
            print_str("User picked up\r\n");
            if (action) recv = '0' + action;
            action = 0;
        }
    }
    
    // if interrupts fire in the wrong order, turn DTMF on again
    enable_dtmf();
}
